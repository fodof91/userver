<!-- HTML header for doxygen 1.8.13-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<link rel="icon" href="../../favicon.svg">
<title>userver: Production configs and best practices</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<link rel="stylesheet" href="../../doxygen-like.css">
<script src="../../highlight.pack.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../customdoxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0" style="width: 100%;">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><a id='logo-anchor' href="../../index.html"><img alt="Logo" src="../../logo.svg"/></a></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname"><a class="titlelink" href="../../index.html">userver
   </a>
   </div>
   <div id="projectbrief"><a class="titlelink" href="../../index.html">C++ Async Framework (beta)</a></div>
  </td>
  <td style="float: right; padding-right: 40px; padding-top: 15px;">
    <a href="https://github.com/userver-framework/userver" rel="noopener" target="_blank" class="titlelink">
      <img src="../../github_logo.svg" alt="Github"/>
    </a>
    &nbsp;
    <a href="https://t.me/+i3k5A6V0oFgwNmYy" rel="noopener" id='telegram_channel' target="_blank" class="titlelink">
      <img src="../../telegram_logo.svg" alt="Telegram"/>
    </a>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Production configs and best practices </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>A good production ready service should have functionality for various cases:</p><ul>
<li>Overload<ul>
<li>Service should respond with HTTP 429 codes to some requests while still being able to handle the rest</li>
</ul>
</li>
<li>Debugging of a running service<ul>
<li>inspect logs</li>
<li>get more logs from the suspiciously behaving service and then turn the logging level back</li>
<li>profile memory usage</li>
<li>see requests in flight</li>
</ul>
</li>
<li>Experiments<ul>
<li>Should be a way to turn on/off arbitrary functionality without restarting the service</li>
</ul>
</li>
<li>Metrics and Logs</li>
<li>Functional testing</li>
</ul>
<p>This tutorial shows a configuration of a typical production ready service.</p>
<h1><a class="anchor" id="autotoc_md327"></a>
Before you start</h1>
<p>Make sure that you can compile and run core tests and read a basic example <a class="el" href="../../d9/d72/md_en_userver_tutorial_hello_service.html">Writing your first HTTP server</a>.</p>
<h1><a class="anchor" id="autotoc_md328"></a>
int main</h1>
<p><a class="el" href="../../d6/d84/namespaceutils.html#a40294f3ed93c7f13cb2c814d70134820">utils::DaemonMain</a> initializes and starts the component system with the provided command line arguments:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="../../d1/d1c/common__component__list_8hpp.html" title="Returns the most common list of components with runtime config updates and HTTP client.">userver/components/common_component_list.hpp</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="../../dc/dec/common__server__component__list_8hpp.html" title="Returns the most common list of components to start a fully functional server.">userver/components/common_server_component_list.hpp</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="../../d8/d39/ping_8hpp.html" title="Handler that returns HTTP 200 if the service is OK and able to process requests.">userver/server/handlers/ping.hpp</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="../../d7/de0/daemon__run_8hpp.html" title="Functions to start a daemon with specified components list.">userver/utils/daemon_run.hpp</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="../../d8/d39/ping_8hpp.html" title="Handler that returns HTTP 200 if the service is OK and able to process requests.">userver/server/handlers/ping.hpp</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="../../dd/d60/core_2include_2userver_2storages_2secdist_2component_8hpp.html" title="Component that stores security related data (keys, passwords, ...).">userver/storages/secdist/component.hpp</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span>* argv[]) {</div>
<div class="line">  <span class="keyword">const</span> <span class="keyword">auto</span> component_list =</div>
<div class="line">      <a class="code" href="../../dc/df0/classcomponents_1_1ComponentList.html" title="A list to keep a unique list of components to start with components::Run(), utils::DaemonMain() or co...">components::ComponentList</a>()</div>
<div class="line">          .AppendComponentList(<a class="code" href="../../dd/d1c/group__userver__components.html#ga447b5378f8d2a465ce2d6b25da09b44c" title="Returns the most common list of components with runtime config updates and HTTP client.">components::CommonComponentList</a>())</div>
<div class="line">          .AppendComponentList(<a class="code" href="../../dd/d1c/group__userver__components.html#gaad51991fd3cbb1c5463c9cda8e41cdbb" title="Returns the most common list of components to start a fully functional server.">components::CommonServerComponentList</a>())</div>
<div class="line">          .Append&lt;<a class="code" href="../../da/dc7/classcomponents_1_1Secdist.html" title="Component that stores security related data (keys, passwords, ...).">components::Secdist</a>&gt;()</div>
<div class="line">          .Append&lt;server::handlers::Ping&gt;()</div>
<div class="line"> </div>
<div class="line">      <span class="comment">// Put your handlers and components here</span></div>
<div class="line">      ;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> <a class="code" href="../../d6/d84/namespaceutils.html#a40294f3ed93c7f13cb2c814d70134820">utils::DaemonMain</a>(argc, argv, component_list);</div>
<div class="line">}</div>
</div><!-- fragment --><p> A path to the static config file should be passed from a command line to start the service:</p>
<div class="fragment"><div class="line">bash</div>
<div class="line">./samples/userver-samples-production_service --config /etc/production-service/static_config.yaml</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md329"></a>
Static config</h1>
<p>Full static config could be seen at <a class="el" href="../../df/d22/samples_2production_service_2static_config_8yaml-example.html">samples/production_service/static_config.yaml</a></p>
<p>Important parts are described down below.</p>
<h2><a class="anchor" id="autotoc_md330"></a>
Variables</h2>
<p>Static configs tend to become quite big, so it is a good idea to move changing parts of it into variables. To do that, declare a <code>config_vars</code> field in the static config and point it to a file with variables.</p>
<div class="fragment"><div class="line"># yaml</div>
<div class="line">config_vars: /etc/production_service/config_vars.yaml</div>
</div><!-- fragment --><p> A file with config variables could look <a class="el" href="../../d8/de0/samples_2production_service_2config_vars_8yaml-example.html">like this</a>.</p>
<p>Now in static config you could use <code>$variable-name</code> to refer to a variable, <code>*#fallback</code> fields are used if there is no variable with such name in the config variables file:</p>
<div class="fragment"><div class="line">        # yaml</div>
<div class="line">        http-client:</div>
<div class="line">            fs-task-processor: fs-task-processor</div>
<div class="line">            user-agent: $server-name</div>
<div class="line">            user-agent#fallback: &#39;userver-based-service 1.0&#39;</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md331"></a>
Task processors</h2>
<p>A good practice is to have at least 3 different task processors:</p>
<div class="fragment"><div class="line">    # yaml</div>
<div class="line">    task_processors:</div>
<div class="line">        fs-task-processor:       # for blocking operations</div>
<div class="line">            thread_name: fs-worker</div>
<div class="line">            worker_threads: $fs_worker_threads</div>
<div class="line">            worker_threads#fallback: 2</div>
<div class="line">        main-task-processor:     # for nonblocking operations</div>
<div class="line">            thread_name: main-worker</div>
<div class="line">            worker_threads: $main_worker_threads</div>
<div class="line">            worker_threads#fallback: 6</div>
<div class="line">        monitor-task-processor:  # for monitoring</div>
<div class="line">            thread_name: mon-worker</div>
<div class="line">            worker_threads: $monitor_worker_threads</div>
<div class="line">            worker_threads#fallback: 1</div>
<div class="line">    event_thread_pool:           # ev pools to deal with OS events</div>
<div class="line">        threads: $event_threads</div>
<div class="line">        threads#fallback: 2</div>
</div><!-- fragment --><p> Moving blocking operations into a separate task processor improves responsiveness and CPU usage of your service. Monitor task processor helps to get statistics and diagnostics from server under heavy load or from a server with a deadlocked threads in the main task processor.</p>
<dl class="section warning"><dt>Warning</dt><dd>This setup is for an abstract service on an abstract 8 core machine. Benchmark your service on your hardware and hand-tune the thread numbers to get optimal performance.</dd></dl>
<h2><a class="anchor" id="autotoc_md332"></a>
Listeners/Monitors</h2>
<p>Note the <a class="el" href="../../d0/d0b/classcomponents_1_1Server.html" title="Component that listens for incomming requests, manages incomming connections and passes the requests ...">components::Server</a> configuration:</p>
<div class="fragment"><div class="line">        # yaml</div>
<div class="line">        server:</div>
<div class="line">            listener:</div>
<div class="line">                # If your service is behind nginx or some other local proxy, it is</div>
<div class="line">                # efficient to accepts incoming requests from unix-socket</div>
<div class="line">                #</div>
<div class="line">                # unix-socket: /var/run/production_service/service.socket</div>
<div class="line">                port: $server-port</div>
<div class="line">                port#fallback: 8085</div>
<div class="line">                connection:</div>
<div class="line">                    in_buffer_size: 32768</div>
<div class="line">                    requests_queue_size_threshold: 100</div>
<div class="line">                task_processor: main-task-processor</div>
<div class="line">            listener-monitor:</div>
<div class="line">                # Listen on localhost:8085 for developer/utility requests</div>
<div class="line">                port: $monitor-server-port</div>
<div class="line">                port#fallback: 8086</div>
<div class="line">                connection:</div>
<div class="line">                    in_buffer_size: 32768</div>
<div class="line">                    requests_queue_size_threshold: 100</div>
<div class="line">                task_processor: monitor-task-processor</div>
<div class="line">            logger_access: &#39;&#39;</div>
<div class="line">            logger_access_tskv: &#39;&#39;</div>
<div class="line">            max_response_size_in_flight: 1000000000</div>
<div class="line">            server-name: $server-name</div>
</div><!-- fragment --><p> In this example we have two listeners. it is done to separate clients and utility/diagnostic handlers to listen on different ports or even interfaces.</p>
<p><a class="anchor" id="sample_prod_service_utility_handlers"></a></p>
<h2><a class="anchor" id="autotoc_md333"></a>
Utility handlers</h2>
<p>Your server has the following utility handlers:</p><ul>
<li>to <a class="el" href="../../d8/dcb/md_en_userver_requests-in-flight.html">inspect in-flight request</a> - <a class="el" href="../../d8/d67/classserver_1_1handlers_1_1InspectRequests.html" title="Handler that returns information about all in-flight requests.">server::handlers::InspectRequests</a></li>
<li>to <a class="el" href="../../d5/d0e/md_en_userver_memory-profile-running-service.html">profile memory usage</a> - <a class="el" href="../../d2/d34/classserver_1_1handlers_1_1Jemalloc.html" title="Handler that controlls the jemalloc allocator.">server::handlers::Jemalloc</a></li>
<li>to <a class="el" href="../../db/d7b/md_en_userver_log-level-running-service.html">change logging level at runtime</a> - <a class="el" href="../../da/da0/classserver_1_1handlers_1_1LogLevel.html" title="Handler that controlls logging levels of all the loggers.">server::handlers::LogLevel</a></li>
<li>to <a class="el" href="../../d4/d4d/md_en_userver_dns-control.html">control the DNS resolver</a> - <a class="el" href="../../d1/d48/classserver_1_1handlers_1_1DnsClientControl.html" title="Handlers that controls the DNS client.">server::handlers::DnsClientControl</a></li>
<li>to <a class="el" href="../../d6/dba/md_en_userver_service-monitor.html">get statistics</a> from the service - <a class="el" href="../../dc/d10/classserver_1_1handlers_1_1ServerMonitor.html" title="Handler that returns statistics data.">server::handlers::ServerMonitor</a></li>
</ul>
<div class="fragment"><div class="line">        # yaml</div>
<div class="line">        handler-inspect-requests:</div>
<div class="line">            path: /service/inspect-requests</div>
<div class="line">            method: GET</div>
<div class="line">            task_processor: monitor-task-processor</div>
<div class="line">        handler-jemalloc:</div>
<div class="line">            path: /service/jemalloc/prof/{command}</div>
<div class="line">            method: POST</div>
<div class="line">            task_processor: monitor-task-processor</div>
<div class="line">        handler-log-level:</div>
<div class="line">            path: /service/log-level/{level}</div>
<div class="line">            method: GET,PUT</div>
<div class="line">            task_processor: monitor-task-processor</div>
<div class="line">        handler-dynamic-debug-log:</div>
<div class="line">            path: /service/log/dynamic-debug</div>
<div class="line">            method: GET,PUT,DELETE</div>
<div class="line">            task_processor: monitor-task-processor</div>
<div class="line">        handler-dns-client-control:</div>
<div class="line">            path: /service/dnsclient/{command}</div>
<div class="line">            method: POST</div>
<div class="line">            task_processor: monitor-task-processor</div>
<div class="line">        handler-server-monitor:</div>
<div class="line">            path: /service/monitor</div>
<div class="line">            method: GET</div>
<div class="line">            task_processor: monitor-task-processor</div>
</div><!-- fragment --><p> All those handlers live on a separate <code>components.server.listener-monitor</code> address, so you have to request them using the <code>listener-monitor</code> credentials:</p>
<div class="fragment"><div class="line">bash</div>
<div class="line">$ curl http://localhost:8085/service/log-level/</div>
<div class="line">{&quot;init-log-level&quot;:&quot;info&quot;,&quot;current-log-level&quot;:&quot;info&quot;}</div>
<div class="line"> </div>
<div class="line">$ curl -X PUT &#39;http://localhost:8085/service/log-level/warning&#39;</div>
<div class="line">{&quot;init-log-level&quot;:&quot;info&quot;,&quot;current-log-level&quot;:&quot;warning&quot;}</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md334"></a>
Ping</h2>
<p>This is a <a class="el" href="../../d7/d6d/classserver_1_1handlers_1_1Ping.html" title="Handler that returns HTTP 200 if the service is OK and able to process requests.">server::handlers::Ping</a> handle that returns 200 if the service is OK, 500 otherwise. Useful for balancers, that would stop sending traffic to the server if it responds with codes other than 200.</p>
<div class="fragment"><div class="line">        # yaml</div>
<div class="line">        handler-ping:</div>
<div class="line">            path: /ping</div>
<div class="line">            method: GET</div>
<div class="line">            task_processor: main-task-processor  # !!!</div>
<div class="line">            throttling_enabled: false</div>
<div class="line">            url_trailing_slash: strict-match</div>
</div><!-- fragment --><p> Note that the ping handler lives on the task processor of all the other handlers. Smart balancers may measure response times and send less traffic to the heavy loaded services.</p>
<div class="fragment"><div class="line">bash</div>
<div class="line">$ curl --unix-socket service.socket http://localhost/ping -i</div>
<div class="line">HTTP/1.1 200 OK</div>
<div class="line">Date: Thu, 01 Jul 2021 12:46:07 UTC</div>
<div class="line">Content-Type: text/html; charset=utf-8</div>
<div class="line">X-YaRequestId: 39e3f54b86984b8ca5235876dc566b27</div>
<div class="line">Server: sample-production-service 1.0</div>
<div class="line">X-YaTraceId: 4d7f8aa03e2d4e4d80a92a3ccecfbe6d</div>
<div class="line">Connection: keep-alive</div>
<div class="line">Content-Length: 0</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md335"></a>
Dynamic configs</h2>
<p>Here's a configuration of a dynamic config related components <a class="el" href="../../d8/d1f/classcomponents_1_1DynamicConfigClient.html" title="Component that starts a clients::dynamic_config::Client client.">components::DynamicConfigClient</a>, <a class="el" href="../../dd/d1a/classcomponents_1_1DynamicConfig.html" title="Component that stores the runtime config.">components::DynamicConfig</a>, <a class="el" href="../../d3/da0/classcomponents_1_1DynamicConfigClientUpdater.html" title="Component that does a periodic update of runtime configs.">components::DynamicConfigClientUpdater</a>.</p>
<p>Service starts with dynamic config values from <code>taxi-config.fs-cache-path</code> file or from <code>taxi-config-client-updater.fallback-path</code> file. Service updates dynamic values from a <a class="el" href="../../dd/d69/md_en_userver_tutorial_config_service.html">configs service</a>.</p>
<div class="fragment"><div class="line">        # yaml</div>
<div class="line">        taxi-config:</div>
<div class="line">            fs-cache-path: $config-cache</div>
<div class="line">            fs-task-processor: fs-task-processor</div>
<div class="line">        taxi-configs-client:</div>
<div class="line">            config-url: $config-server-url</div>
<div class="line">            http-retries: 5</div>
<div class="line">            http-timeout: 20s</div>
<div class="line">            service-name: $service-name</div>
<div class="line">        taxi-config-client-updater:</div>
<div class="line">            config-settings: false</div>
<div class="line">            fallback-path: $config-fallback</div>
<div class="line">            full-update-interval: 1m</div>
<div class="line">            load-only-my-values: true</div>
<div class="line">            store-enabled: true</div>
<div class="line">            update-interval: 5s</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md336"></a>
Congestion Control</h2>
<p><a class="el" href="../../de/dac/classcongestion__control_1_1Component.html" title="Component to limit too active requests, also known as CC.">congestion_control::Component</a> limits the active requests count. In case of overload it responds with HTTP 429 codes to some requests, allowing your service to properly process handle the rest.</p>
<p>All the significant parts of the component are configured by dynamic config options <a class="el" href="../../dd/d2c/md_en_schemas_dynamic_configs.html#USERVER_RPS_CCONTROL">USERVER_RPS_CCONTROL</a> and <a class="el" href="../../dd/d2c/md_en_schemas_dynamic_configs.html#USERVER_RPS_CCONTROL_ENABLED">USERVER_RPS_CCONTROL_ENABLED</a></p>
<div class="fragment"><div class="line">        # yaml</div>
<div class="line">        congestion-control:</div>
<div class="line">            fake-mode: $testsuite-enabled</div>
<div class="line">            load-enabled: true</div>
</div><!-- fragment --><p> It is a good idea to disable it in unit tests to avoid getting HTTP 429 on an overloaded CI server.</p>
<h2><a class="anchor" id="autotoc_md337"></a>
Metrics</h2>
<p>Metrics is a convenient way to monitor the health of your service.</p>
<p>Typical setup of <a class="el" href="../../df/df4/classcomponents_1_1SystemStatisticsCollector.html" title="Component for system resource usage statistics collection.">components::SystemStatisticsCollector</a> and <a class="el" href="../../d8/daf/classcomponents_1_1StatisticsStorage.html" title="Component that keeps a utils::statistics::Storage storage for metrics.">components::StatisticsStorage</a> is quite trivial:</p>
<div class="fragment"><div class="line">        # yaml</div>
<div class="line">        statistics-storage:</div>
<div class="line">        system-statistics-collector:</div>
<div class="line">            fs-task-processor: fs-task-processor</div>
</div><!-- fragment --><p> With such setup you could poll the metrics from handler <a class="el" href="../../dc/d10/classserver_1_1handlers_1_1ServerMonitor.html" title="Handler that returns statistics data.">server::handlers::ServerMonitor</a> that we've configured in <a class="el" href="../../d6/d08/md_en_userver_tutorial_production_service.html#sample_prod_service_utility_handlers">previous section</a>. However a much more mature approach is to write a component that pushes the metrics directly into the remote metrics aggregation service or to write a handle that provides the metrics in the native aggregation service format.</p>
<h2><a class="anchor" id="autotoc_md338"></a>
Secdist - secrets distributor</h2>
<p>Storing sensitive data aside from the configs is a good practice that allows you to set different access rights for the two files.</p>
<p><a class="el" href="../../da/dc7/classcomponents_1_1Secdist.html" title="Component that stores security related data (keys, passwords, ...).">components::Secdist</a> configuration is straightforward:</p>
<div class="fragment"><div class="line">        # yaml</div>
<div class="line">        secdist:</div>
<div class="line">            config: $secdist-path</div>
</div><!-- fragment --><p> Refer to the <a class="el" href="../../de/d15/classstorages_1_1secdist_1_1SecdistConfig.html" title="Client to retrieve credentials from the components::Secdist.">storages::secdist::SecdistConfig</a> config for more information on the data retrieval.</p>
<p><a class="anchor" id="prod_service_testsuite_related_components"></a></p>
<h2><a class="anchor" id="autotoc_md339"></a>
Testsuite related components</h2>
<p><a class="el" href="../../d5/ded/classserver_1_1handlers_1_1TestsControl.html" title="Handler that allows to control the behavior of server from tests.">server::handlers::TestsControl</a> is a handle that allows controlling the service from test environments. That handle is used by the testsuite from <a class="el" href="../../d1/dd6/md_en_userver_functional_testing.html">functional tests</a> to mock time, invalidate caches, testpoints and many other things. This component should be disabled in production environments.</p>
<p><a class="el" href="../../d9/de2/classcomponents_1_1TestsuiteSupport.html" title="Testsuite support component.">components::TestsuiteSupport</a> is a lightweight storage to keep minor testsuite data. This component is required by many high-level components and it is safe to use this component in production environments.</p>
<h1><a class="anchor" id="autotoc_md340"></a>
Dynamic config</h1>
<p>Initial values of the dynamic config could be seen at <a class="el" href="../../d7/ddc/samples_2production_service_2dynamic_config_fallback_8json-example.html">samples/production_service/dynamic_config_fallback.json</a></p>
<p>Those are described in details at <a class="el" href="../../dd/d2c/md_en_schemas_dynamic_configs.html">Dynamic configs</a> .</p>
<h2><a class="anchor" id="autotoc_md341"></a>
Build</h2>
<p>This sample requires <a class="el" href="../../dd/d69/md_en_userver_tutorial_config_service.html">configs service</a>, so we build and start one from our previous tutorials.</p>
<div class="fragment"><div class="line">bash</div>
<div class="line">mkdir build_release</div>
<div class="line">cd build_release</div>
<div class="line">cmake -DCMAKE_BUILD_TYPE=Release ..</div>
<div class="line"> </div>
<div class="line">make userver-samples-config_service</div>
<div class="line">./samples/userver-samples-config_service &amp;</div>
<div class="line"> </div>
<div class="line">make userver-samples-production_service</div>
<div class="line">python3 ../samples/tests/prepare_production_configs.py</div>
<div class="line">./samples/userver-samples-production_service --config /tmp/userver/production_service/static_config.yaml</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md342"></a>
Functional testing</h2>
<p><a class="el" href="../../d1/dd6/md_en_userver_functional_testing.html">Functional tests</a> are used to make sure that the service is working fine and implements the required functionality. A recommended practice is to build the service in Debug and Release modes and tests both of them, then deploy the Release build to the production, "disabling all the tests related handlers".</p>
<p>Debug builds of the userver provide numerous assertions that validate the framework usage and help to detect bugs at early stages.</p>
<p>Typical functional tests for a service consist of a <code>conftest.py</code> file with mocks+configs for the sereffectivelyvice and a bunch of <code>test_*.py</code> files with actual tests. Such approach allows to reuse mocks and configurations in different tests.</p>
<h1><a class="anchor" id="autotoc_md343"></a>
Full sources</h1>
<p>See the full example at</p><ul>
<li><a class="el" href="../../d8/d8a/samples_2production_service_2production_service_8cpp-example.html">samples/production_service/production_service.cpp</a></li>
<li><a class="el" href="../../df/d22/samples_2production_service_2static_config_8yaml-example.html">samples/production_service/static_config.yaml</a></li>
<li><a class="el" href="../../d8/de0/samples_2production_service_2config_vars_8yaml-example.html">samples/production_service/config_vars.yaml</a></li>
<li><a class="el" href="../../d7/ddc/samples_2production_service_2dynamic_config_fallback_8json-example.html">samples/production_service/dynamic_config_fallback.json</a></li>
<li><a class="el" href="../../db/dec/samples_2production_service_2CMakeLists_8txt-example.html">samples/production_service/CMakeLists.txt</a></li>
<li><a class="el" href="../../d4/db8/samples_2production_service_2tests_2conftest_8py-example.html">samples/production_service/tests/conftest.py</a></li>
<li><a class="el" href="../../dc/d17/samples_2production_service_2tests_2test_ping_8py-example.html">samples/production_service/tests/test_ping.py</a></li>
<li><a class="el" href="../../d6/d5a/samples_2production_service_2tests_2test_production_8py-example.html">samples/production_service/tests/test_production.py</a> </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- HTML footer for doxygen 1.8.13-->
<!-- start footer part -->
<hr class="footer"/>
<a id='page_edit' style="float:left; padding-left: 7pt;" href="#">⚒ Редактировать страницу</a>
<address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="../../doxygen.png" alt="doxygen"/>
</a> 1.8.17
</small></address>
<script type="text/javascript">
const LOWER_CASE_TRANSLITTERATION_MAPPING = {
    "а":"a", "б":"b", "в":"v", "г":"g", "д":"d", "е":"e", "ё":"jo", "ж":"zh",
    "з":"z", "и":"i", "й":"jj", "к":"k", "л":"l", "м":"m", "н":"n", "о":"o",
    "п":"p", "р":"r", "с":"s", "т":"t", "у":"u", "ф":"f", "х":"x", "ц":"c",
    "ч":"ch", "ш":"sh", "щ":"shh", "ъ":"\'", "ы":"y", "ь":"\'", "э":"je",
    "ю":"ju", "я":"ja"
};
const DOXYGEN_DIAMOND_STRING = '◆\u00A0' // ◆&nbsp;
function make_id(raw_id) {
    return raw_id.toLowerCase().split('').map(function (char) {
        return LOWER_CASE_TRANSLITTERATION_MAPPING[char] || char;
    }).join('').replace(/\W/g, '');
}
const html_escape = function () {
    const p = document.createElement('p');
    return function (text) {
        p.textContent = text;
        return p.innerHTML;
    };
}();
function setup_page_edit() {
    let href = window.location.href;
    const idx = href.indexOf('md_ru_');
    if (idx === -1) {
        $('#page_edit').hide();
        return;
    }
    href = href.substring(idx).split('.html')[0];
    href = href.split('#')[0];
    href = href.replace('md_ru_', 'https://wiki.yandex-team.ru/taxi/backend/');
    href = href.replaceAll('_', '/');
    $('#page_edit').attr("href", href + '/.edit');
}
function draw_toc() {
    let headers = $(':header');
    if (headers.length === 0) {
        return;
    }
    let sidenav_content = '<div id="mySidenav" class="sidenav">';
    sidenav_content += '<h2>Table of contents</h2>';
    headers.each(function() {
        let index = parseInt(this.nodeName.substring(1)) - 1;
        const header = $(this);
        let id = header.attr('id');
        if (!id) {
          id = make_id(header.text())
          header.attr('id', id);
        }
        let header_text = header.text()
        if (header_text.startsWith(DOXYGEN_DIAMOND_STRING)) {
            ++index;
            header_text = header_text.substring(DOXYGEN_DIAMOND_STRING.length);
        }
        sidenav_content += ''
          + '<a href="#' + id + '" style="padding-left: ' + index * 15 + 'px">'
          + '•&nbsp;' + html_escape(header_text)
          + '</a>'
        ;
        header.append(' <a class="hoverlink" href="#' + id + '">🔗</a>')
    });
    sidenav_content += '</div>';
    $(sidenav_content).insertAfter('.header');
}
function highlight_code() {
    if (window.location.href.indexOf("pp_source") !== -1
        || window.location.href.indexOf("cpp-example") !== -1) {
        // Header listing is already nicely highlighted by Doxygen
        return;
    }
    hljs.configure({
        tabReplace: '    ' // 4 spaces
    });
    hljs.registerAliases('py', {languageName: 'python'});
    hljs.registerAliases('sh', {languageName: 'shell'});
    hljs.registerAliases('bash', {languageName: 'shell'});
    hljs.registerAliases('yml', {languageName: 'yaml'});
    hljs.registerAliases('plain', {languageName: 'plaintext'});
    hljs.registerAliases('tskv', {languageName: 'plaintext'});
    $(".fragment").each(function() {
        const node = $(this);
        let data = '';
        let language = '';
        let requires_higlighting = true;
        node.children('div.line').each(function(i) {
            line = $(this).text();
            // Doxygen 1.8.11 workaround to remove line numbers.
            // No line numbers added in Doxygen 1.8.13
            line = line.replace(/^ *\d+\xA0/, '');
            if (i === 0) {
                line = line.trimLeft().replace(/^# /, '');
                if (line === 'autodetect') {
                    return true;
                } else if (hljs.getLanguage(line)) {
                    language = line;
                    return true;
                } else {
                    requires_higlighting = false;
                    return false;
                }
            }
            data += line + '\n';
        });
        if (requires_higlighting === false) {
            return;
        }
        if (language !== '') {
            data = hljs.highlight(language, data).value;
        } else {
            data = hljs.highlightAuto(data).value;
        }
        node.replaceWith('<div class="fragment"><pre>' + data + '</pre></div>');
    });
}
function setup_if_landing() {
    if (document.getElementById('landing_logo_id') === null) {
        return false;
    }
    $('#titlearea').hide();
    const main_nav = $('#main-nav')
    main_nav.addClass('main-nav-landing');
    main_nav.append('<hr>');
    $('.header').hide();
    $('body').css('background-color', 'black');
    $('#page_edit').hide();
    return true;
}
function sticky_menu() {
    const main_nav = $('#main-nav');
    const menu_y_position = 94;
    const search_results_window = $('#MSearchResultsWindow');
    var menu_is_sticky = false;
    const stick = function () {
        if ($(this).scrollTop() > menu_y_position) {
            if (menu_is_sticky) return;
            search_results_window.addClass('stickySearchResults');
            main_nav.addClass('stickyHeader');
            menu_is_sticky = true;
        } else {
            if (!menu_is_sticky) return;
            search_results_window.removeClass('stickySearchResults');
            // 'top' property of the results window is computed by Doxygen JS
            // and it may give bad results if the computation is invoked at the
            // middle of the page.
            //
            // Hiding the window. Doxygen will recompute and show it on new
            // user input.
            search_results_window.hide();
            main_nav.removeClass('stickyHeader');
            menu_is_sticky = false;
        }
    };
    stick();  // on page refresh draw the menu on a right position
    $(window).on("scroll", stick);
}
function telegram_channel_language() {
  if (/^ru/.test(navigator.language)) {
    const channel = $('#telegram_channel');
    if (channel) {
      channel.attr('href', 'https://t.me/+AdadhDPVG5xhNWRi');
    }
  }
}
$(function() {
    if (setup_if_landing()) return;
    draw_toc();
    highlight_code();
    setup_page_edit();
    telegram_channel_language();
    sticky_menu();
});
</script>
</body>
</html>
