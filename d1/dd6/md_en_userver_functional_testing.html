<!-- HTML header for doxygen 1.8.13-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<link rel="icon" href="../../favicon.svg">
<title>userver: Functional service tests (testsuite)</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<link rel="stylesheet" href="../../doxygen-like.css">
<script src="../../highlight.pack.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../customdoxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0" style="width: 100%;">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><a id='logo-anchor' href="../../index.html"><img alt="Logo" src="../../logo.svg"/></a></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname"><a class="titlelink" href="../../index.html">userver
   </a>
   </div>
   <div id="projectbrief"><a class="titlelink" href="../../index.html">C++ Async Framework (beta)</a></div>
  </td>
  <td style="float: right; padding-right: 40px; padding-top: 15px;">
    <a href="https://github.com/userver-framework/userver" rel="noopener" target="_blank" class="titlelink">
      <img src="../../github_logo.svg" alt="Github"/>
    </a>
    &nbsp;
    <a href="https://t.me/+i3k5A6V0oFgwNmYy" rel="noopener" id='telegram_channel' target="_blank" class="titlelink">
      <img src="../../telegram_logo.svg" alt="Telegram"/>
    </a>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Functional service tests (testsuite) </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="autotoc_md108"></a>
Getting started</h1>
<p>Userver has built-in support for functional service tests using <a href="https://pypi.org/project/yandex-taxi-testsuite/">Yandex.Taxi Testsuite</a>. Testsuite is based on <a href="https://pytest.org/">pytest</a> and allows developers to test thier services in isolated environment. It starts service binary with minimal database and all external services mocked then allows developer to call service handlers and test their result.</p>
<p>Supported features:</p>
<ul>
<li>Database startup (Mongo, Postgresql, Clickhouse, ...)</li>
<li>Per-test database state</li>
<li>Service startup</li>
<li>Mocksever to mock external service handlers</li>
<li>Mock service time, <code><a class="el" href="../../db/dec/namespaceutils_1_1datetime.html#a55c8fa2daccb0874282e200e656e005f" title="std::chrono::system_clock::now() that could be mocked">utils::datetime::Now()</a></code></li>
<li>Testpoint</li>
<li>Cache invalidation</li>
<li>Logs capture</li>
</ul>
<h1><a class="anchor" id="autotoc_md109"></a>
CMake integration</h1>
<p>With <code>userver_testsuite_add()</code> function you can easily add testsuite support to your project. Its main purpose is:</p>
<ul>
<li>Setup Python environment <code>virtualenv</code> or uses existing one.</li>
<li>Create runner script that setups <code>PYTHONPATH</code> and passes extra arguments to <code>pytest</code>.</li>
<li>Registers <code>ctest</code> target.</li>
</ul>
<p><a class="el" href="../../d0/d5d/cmake_2UserverTestsuite_8cmake-example.html">cmake/UserverTestsuite.cmake</a> library is automatically addded to CMake path after userever enviroment setup. Add the following line to use it:</p>
<div class="fragment"><div class="line">include(UserverTestsuite)</div>
</div><!-- fragment --><p> Then create testsuite target: </p><div class="fragment"><div class="line">userver_testsuite_add(</div>
<div class="line">  NAME <a class="code" href="../../d3/d56/namespacetestsuite.html" title="Testsuite integration.">testsuite</a>-${PROJECT_NAME}</div>
<div class="line">  WORKING_DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR}/tests</div>
<div class="line">  PYTHON_BINARY ${TESTSUITE_PYTHON_BINARY}</div>
<div class="line">  PYTEST_ARGS</div>
<div class="line">  --service-config=${CMAKE_CURRENT_SOURCE_DIR}/static_config.yaml</div>
<div class="line">  --service-binary=${CMAKE_CURRENT_BINARY_DIR}/${PROJECT_NAME}</div>
<div class="line">  --config-fallback=${CMAKE_CURRENT_SOURCE_DIR}/dynamic_config_fallback.json</div>
<div class="line">  --service-config-vars=${CMAKE_CURRENT_SOURCE_DIR}/config_vars.yaml</div>
<div class="line">)</div>
</div><!-- fragment --> <h2><a class="anchor" id="autotoc_md110"></a>
Arguments</h2>
<ul>
<li>NAME, required test name used as <code>ctest</code> target name.</li>
<li>WORKING_DIRECTORY, pytest working directory. Default is ${CMAKE_CURRENT_SOURCE_DIR}.</li>
<li>PYTEST_ARGS, list of extra arguments passed to <code>pytest</code>.</li>
<li>PYTHONPATH, list of directories to be prepended to <code>PYTHONPATH</code>.</li>
<li>REQUIREMENTS, list of reqirements.txt files used to populate <code>virtualenv</code>.</li>
<li>PYTHON_BINARY, path to existing Python binary.</li>
</ul>
<h2><a class="anchor" id="autotoc_md111"></a>
Python environment</h2>
<p>You may want to create new virtual environment with its own set of packages. Or reuse existing one. That could be done this way:</p>
<ul>
<li>If REQUIREMENTS is given then new virtualenv is created</li>
<li>Else if PYTHON_BINARY is specified it's used</li>
<li>Otherwise value of ${TESTSUITE_VENV_PYTHON} is used</li>
</ul>
<p>Basic <code>requirements.txt</code> file may look like this:</p>
<div class="fragment"><div class="line">yandex-taxi-testsuite[mongodb]</div>
</div><!-- fragment --><p>Creating per-testsuite virtual environment is a recommended way to go. It creates virtualenv that could be found in current binary directory:</p>
<p><code>${CMAKE_CURRENT_BINARY_DIR}/venv-${ARG_NAME}</code></p>
<h2><a class="anchor" id="autotoc_md112"></a>
Run with ctest</h2>
<p><code>userver_testsuite_add()</code> registers a ctest target with name NAME. Run all project tests with ctest command or use filters to run specific tests:</p>
<div class="fragment"><div class="line">ctest -V -R my-project  # NAME argument is used</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md113"></a>
Direct run</h2>
<p>To run pytest directly <code>userver_testsuite_add()</code> creates a testsuite runner script that could be found in corresponding binary directory. This may be useful to run a single testcase, to start the testsuite with gdb or to start the testsuite with extra pytest arguments:</p>
<p><code>${CMAKE_CURRENT_BINARY_DIR}/runtests-${ARG_NAME}</code></p>
<p>You can use it to manually start testsuite with extra <code>pytest</code> arguments, e.g.:</p>
<div class="fragment"><div class="line">./build/tests/runtests-my-project -vvx ./tests -k test_foo</div>
</div><!-- fragment --><p>Please refer to <code>testuite</code> and <code>pytest</code> documentation for available options. Run it with <code>--help</code> argument to see the short options description.</p>
<div class="fragment"><div class="line">./build/tests/runtests-my-project ./tests --help</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md114"></a>
pytest_userver</h1>
<p>By default internal <code>pytest_userver</code> plugin is included in python path. It provides basic testsuite support for userver service. To use it add it to your <code>pytest_plugins</code> in root <code>conftest.py</code>:</p>
<div class="fragment"><div class="line">pytest_plugins = [<span class="stringliteral">&#39;pytest_userver.plugins&#39;</span>]</div>
</div><!-- fragment --><p> It requires extra PYTEST_ARGS to be passed:</p>
<div class="fragment"><div class="line">userver_testsuite_add(</div>
<div class="line">  NAME <a class="code" href="../../d3/d56/namespacetestsuite.html" title="Testsuite integration.">testsuite</a>-${PROJECT_NAME}</div>
<div class="line">  WORKING_DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR}/tests</div>
<div class="line">  PYTHON_BINARY ${TESTSUITE_PYTHON_BINARY}</div>
<div class="line">  PYTEST_ARGS</div>
<div class="line">  --service-config=${CMAKE_CURRENT_SOURCE_DIR}/static_config.yaml</div>
<div class="line">  --service-binary=${CMAKE_CURRENT_BINARY_DIR}/${PROJECT_NAME}</div>
<div class="line">  --config-fallback=${CMAKE_CURRENT_SOURCE_DIR}/dynamic_config_fallback.json</div>
<div class="line">  --service-config-vars=${CMAKE_CURRENT_SOURCE_DIR}/config_vars.yaml</div>
<div class="line">)</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md115"></a>
Userver testsuite support</h2>
<p>Userver has built-in support for testsuite.</p>
<p>In order to use it you need to register correspoding components:</p>
<p>Headers:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="../../d6/d43/tests__control_8hpp.html" title="Handler that allows to control the behavior of server from tests.">userver/server/handlers/tests_control.hpp</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="../../d3/d37/testsuite__support_8hpp.html" title="Testsuite support component.">userver/testsuite/testsuite_support.hpp</a>&gt;</span></div>
</div><!-- fragment --><p> Add components to components list:</p>
<div class="fragment"><div class="line">          .Append&lt;<a class="code" href="../../d9/de2/classcomponents_1_1TestsuiteSupport.html" title="Testsuite support component.">components::TestsuiteSupport</a>&gt;()</div>
<div class="line">          .Append&lt;server::handlers::TestsControl&gt;()</div>
</div><!-- fragment --><p> Add testsuite components to <code>config.yaml</code>:</p>
<div class="fragment"><div class="line">        tests-control:</div>
<div class="line">            load-enabled: $testsuite-enabled</div>
<div class="line">            path: /tests/control</div>
<div class="line">            method: POST</div>
<div class="line">            task_processor: main-task-processor</div>
<div class="line">            testpoint-timeout: 10s</div>
<div class="line">            testpoint-url: mockserver/testpoint</div>
<div class="line">            throttling_enabled: false</div>
<div class="line">        testsuite-support:</div>
</div><!-- fragment --><p>Please note that the testsuite support must be disabled in production enviroment. Testsuite sets the <code>testsuite-enabled</code> variable into <code>true</code> when runs the service. In the example above this variable controls whether or <code>tests-control</code> component is loaded.</p>
<h2><a class="anchor" id="autotoc_md116"></a>
Features</h2>
<h3><a class="anchor" id="autotoc_md117"></a>
Service config generation</h3>
<p><code>pytest_userver</code> uses config.yaml and config_vars.yaml passed to pytest to generate services configs. <code>pytest_userver</code> provides a way to modify this configs before startings service. You can decalre <code>USERVER_CONFIG_HOOKS</code> variable in your pytest-plugin it is list of functions or pytest-fixtures that are run before config is written to disk. Example usage:</p>
<div class="fragment"><div class="line">USERVER_CONFIG_HOOKS = [<span class="stringliteral">&#39;userver_config_configs_client&#39;</span>]</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">@pytest.fixture(scope=<span class="stringliteral">&#39;session&#39;</span>)</div>
<div class="line"><span class="keyword">def </span>userver_config_configs_client(mockserver_info):</div>
<div class="line">    <span class="keyword">def </span>do_patch(config_yaml, config_vars):</div>
<div class="line">        components = config_yaml[<span class="stringliteral">&#39;components_manager&#39;</span>][<span class="stringliteral">&#39;components&#39;</span>]</div>
<div class="line">        components[<span class="stringliteral">&#39;taxi-configs-client&#39;</span>][</div>
<div class="line">            <span class="stringliteral">&#39;config-url&#39;</span></div>
<div class="line">        ] = mockserver_info.base_url.rstrip(<span class="stringliteral">&#39;/&#39;</span>)</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> do_patch</div>
</div><!-- fragment --> <h3><a class="anchor" id="autotoc_md118"></a>
Service client</h3>
<p>Fixture <code>service_client</code> is used to access service being tested:</p>
<div class="fragment"><div class="line">async <span class="keyword">def </span>test_ping(service_client):</div>
<div class="line">    response = await service_client.get(<span class="stringliteral">&#39;/ping&#39;</span>)</div>
<div class="line">    <span class="keyword">assert</span> response.status == 200</div>
</div><!-- fragment --><p> When <code>tests-control</code> component is enabled service_client is <code><a class="el" href="../../d5/d79/classpytest__userver_1_1client_1_1Client.html">pytest_userver.client.Client</a></code> instance. Which supports special testsuite related methods.</p>
<p>On first call to <code>service_client</code> service state is implicitly updated, e.g.: caches, mocked time, etc.</p>
<h3><a class="anchor" id="autotoc_md119"></a>
Service environment variables</h3>
<p>Use this fixture to provide extra environment variables for your service:</p>
<div class="fragment"><div class="line">@pytest.fixture(scope=<span class="stringliteral">&#39;session&#39;</span>)</div>
<div class="line"><span class="keyword">def </span>service_env():</div>
<div class="line">    <span class="keywordflow">return</span> {<span class="stringliteral">&#39;SECDIST_CONFIG&#39;</span>: json.dumps(SECDIST_CONFIG)}</div>
</div><!-- fragment --> <h3><a class="anchor" id="autotoc_md120"></a>
Extra client dependencies</h3>
<p>Use this fixture to provide extra fixtures that your service depends on:</p>
<div class="fragment"><div class="line">@pytest.fixture</div>
<div class="line"><span class="keyword">def </span>client_deps(pgsql):</div>
<div class="line">    <span class="keywordflow">pass</span></div>
</div><!-- fragment --> <h3><a class="anchor" id="autotoc_md121"></a>
Mockserver</h3>
<p><a href="https://yandex.github.io/yandex-taxi-testsuite/mockserver/">Mockserver</a> allows to mock external HTTP handlers. It starts its own HTTP server that receives HTTP traffic from service being tested. And allows to install custom HTTP handlers within testsuite. In order to use it all HTTP clients must be pointed to mockserver address.</p>
<p>Mockserver usage example:</p>
<div class="fragment"><div class="line">@pytest.fixture(autouse=<span class="keyword">True</span>)</div>
<div class="line"><span class="keyword">def </span>mock_translations(mockserver, translations, mocked_time):</div>
<div class="line">    @mockserver.json_handler(<span class="stringliteral">&#39;/v1/translations&#39;</span>)</div>
<div class="line">    <span class="keyword">def </span>mock(request):</div>
<div class="line">        <span class="keywordflow">return</span> {</div>
<div class="line">            <span class="stringliteral">&#39;content&#39;</span>: translations,</div>
<div class="line">            <span class="stringliteral">&#39;update_time&#39;</span>: utils.timestring(mocked_time.now()),</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> mock</div>
</div><!-- fragment --><ul>
<li>Testcase: <a class="el" href="../../dd/df0/samples_2http_caching_2tests_2conftest_8py-example.html">samples/http_caching/tests/conftest.py</a></li>
</ul>
<h3><a class="anchor" id="autotoc_md122"></a>
Mock time</h3>
<p>Userver provides a way to mock internal datetime value. It only works for datetime retrieved with <code><a class="el" href="../../db/dec/namespaceutils_1_1datetime.html#a55c8fa2daccb0874282e200e656e005f" title="std::chrono::system_clock::now() that could be mocked">utils::datetime::Now()</a></code>, see <a href="../../#utest-mocked-time">Mocked time section</a> for details.</p>
<p>From testsuite you can control it with <a href="https://yandex.github.io/yandex-taxi-testsuite/other_plugins/#mocked-time">mocked_time</a> plugin.</p>
<p>Example usage:</p>
<div class="fragment"><div class="line">@pytest.mark.now(<span class="stringliteral">&#39;2019-12-31T11:22:33Z&#39;</span>)</div>
<div class="line">async <span class="keyword">def </span>test_now(service_client, mocked_time):</div>
<div class="line">    response = await service_client.get(<span class="stringliteral">&#39;/now&#39;</span>)</div>
<div class="line">    <span class="keyword">assert</span> response.status == 200</div>
<div class="line">    <span class="keyword">assert</span> response.json() == {<span class="stringliteral">&#39;now&#39;</span>: <span class="stringliteral">&#39;2019-12-31T11:22:33+00:00&#39;</span>}</div>
<div class="line"> </div>
<div class="line">    <span class="comment"># Change mocked time and sync state</span></div>
<div class="line">    mocked_time.sleep(671)</div>
<div class="line">    await service_client.update_server_state()</div>
<div class="line"> </div>
<div class="line">    response = await service_client.get(<span class="stringliteral">&#39;/now&#39;</span>)</div>
<div class="line">    <span class="keyword">assert</span> response.status == 200</div>
<div class="line">    <span class="keyword">assert</span> response.json() == {<span class="stringliteral">&#39;now&#39;</span>: <span class="stringliteral">&#39;2019-12-31T11:33:44+00:00&#39;</span>}</div>
</div><!-- fragment --><p> Example are available here:</p>
<ul>
<li>C++ code: <a class="el" href="../../d0/d58/samples_2testsuite-support_2now_8cpp-example.html">samples/testsuite-support/now.cpp</a></li>
<li>Testcase: <a class="el" href="../../dd/df0/samples_2testsuite-support_2tests_2test_mocked_time_8py-example.html">samples/testsuite-support/tests/test_mocked_time.py</a></li>
</ul>
<h2><a class="anchor" id="autotoc_md123"></a>
Testpoint</h2>
<p><a href="https://yandex.github.io/yandex-taxi-testsuite/testpoint/">Testpoints</a> are used to send messages from the service to testcase and back. Typical use cases are:</p>
<ul>
<li>Retrieve intermediate state of the service and test it</li>
<li>Inject errors into the service</li>
<li>Synchronize service and testcase execution</li>
</ul>
<p>First of all you should include testpoint header:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="../../d9/d1d/testpoint_8hpp.html" title="Send testpoint notification. Works only if testpoint support is enabled (e.g. in components::TestsCon...">userver/testsuite/testpoint.hpp</a>&gt;</span></div>
</div><!-- fragment --><p> It provides <code><a class="el" href="../../d9/d1d/testpoint_8hpp.html#a8a6d27a839e4327f705ac8d965e4b6e8" title="Send testpoint notification. Works only if testpoint support is enabled (e.g. in components::TestsCon...">TESTPOINT()</a></code> and family of <code><a class="el" href="../../d9/d1d/testpoint_8hpp.html#affc6f7542ce4c6a761234d96c33f43d0" title="Send testpoint notification and receive data. Works only if testpoint support is enabled (e....">TESTPOINT_CALLBACK()</a></code> macroses that do nothing in production environment and only work when run under testsuite. Under testsuite they only make sense when corresponding testsuite handler is installed.</p>
<p>All testpoints has their own name that is used to call named testsuite handler. Second argument is <code><a class="el" href="../../de/d91/classformats_1_1json_1_1Value.html" title="Non-mutable JSON value representation.">formats::json::Value()</a></code> instance that is only evaluated under testsuite.</p>
<p><code><a class="el" href="../../d9/d1d/testpoint_8hpp.html#a8a6d27a839e4327f705ac8d965e4b6e8" title="Send testpoint notification. Works only if testpoint support is enabled (e.g. in components::TestsCon...">TESTPOINT()</a></code> usage sample:</p>
<div class="fragment"><div class="line">  <a class="code" href="../../d9/d1d/testpoint_8hpp.html#a8a6d27a839e4327f705ac8d965e4b6e8" title="Send testpoint notification. Works only if testpoint support is enabled (e.g. in components::TestsCon...">TESTPOINT</a>(<span class="stringliteral">&quot;simple-testpoint&quot;</span>, [] {</div>
<div class="line">    <a class="code" href="../../d2/daa/classformats_1_1json_1_1ValueBuilder.html" title="Builder for JSON.">formats::json::ValueBuilder</a> builder;</div>
<div class="line">    builder[<span class="stringliteral">&quot;payload&quot;</span>] = <span class="stringliteral">&quot;Hello, world!&quot;</span>;</div>
<div class="line">    <span class="keywordflow">return</span> builder.<a class="code" href="../../d2/daa/classformats_1_1json_1_1ValueBuilder.html#a078ae0edbffa37a654914629000680ad" title="Take out the resulting Value object. After calling this method the object is in unspecified (but vali...">ExtractValue</a>();</div>
<div class="line">  }());</div>
</div><!-- fragment --><p> Then you can use testpoint from testcase:</p>
<div class="fragment"><div class="line">async <span class="keyword">def </span>test_basic(service_client, testpoint):</div>
<div class="line">    @testpoint(<span class="stringliteral">&#39;simple-testpoint&#39;</span>)</div>
<div class="line">    <span class="keyword">def </span>simple_testpoint(data):</div>
<div class="line">        <span class="keyword">assert</span> data == {<span class="stringliteral">&#39;payload&#39;</span>: <span class="stringliteral">&#39;Hello, world!&#39;</span>}</div>
<div class="line"> </div>
<div class="line">    response = await service_client.get(<span class="stringliteral">&#39;/testpoint&#39;</span>)</div>
<div class="line">    <span class="keyword">assert</span> response.status == 200</div>
<div class="line">    <span class="keyword">assert</span> simple_testpoint.times_called == 1</div>
</div><!-- fragment --><p> In order to eliminate unnecessary testpoint requests userver keeps track of testpoints that have testsuite handlers installed. Usually testpoint handlers are declared before first call to <code>service_client</code> which implicitly updates userver's list of testpoint. Sometimes it might be required to manually update server state. This can be achieved using <code>service_client.update_server_state()</code> method e.g.:</p>
<div class="fragment"><div class="line">    @testpoint(<span class="stringliteral">&#39;injection-point&#39;</span>)</div>
<div class="line">    <span class="keyword">def </span>injection_point(data):</div>
<div class="line">        <span class="keywordflow">return</span> {<span class="stringliteral">&#39;value&#39;</span>: <span class="stringliteral">&#39;injected&#39;</span>}</div>
<div class="line"> </div>
<div class="line">    await service_client.update_server_state()</div>
<div class="line">    <span class="keyword">assert</span> injection_point.times_called == 0</div>
</div><!-- fragment --><p> Accessing testpoint userver is not aware of will raise an exception:</p>
<div class="fragment"><div class="line">    <span class="keyword">with</span> pytest.raises(</div>
<div class="line">            <a class="code" href="../../d5/d1e/classpytest__userver_1_1plugins_1_1testpoint_1_1UnregisteredTestpointError.html">pytest_userver.plugins.testpoint.UnregisteredTestpointError</a>,</div>
<div class="line">    ):</div>
<div class="line">        <span class="keyword">assert</span> injection_point.times_called == 0</div>
</div><!-- fragment --><ul>
<li>C++ code: <a class="el" href="../../d3/dbf/samples_2testsuite-support_2testpoint_8cpp-example.html">samples/testsuite-support/testpoint.cpp</a></li>
<li>Testcase: <a class="el" href="../../d9/d75/samples_2testsuite-support_2tests_2test_testpoint_8py-example.html">samples/testsuite-support/tests/test_testpoint.py</a></li>
</ul>
<h3><a class="anchor" id="autotoc_md124"></a>
Logs capture</h3>
<p>Testsuite can be used to test logs written by service. To achieve this the testsuite starts a simple logs capture TCP server and tells the service to replicate logs to it on per test basis.</p>
<p>Example usage: </p><div class="fragment"><div class="line">async <span class="keyword">def </span>test_select(service_client):</div>
<div class="line">    async <span class="keyword">with</span> service_client.capture_logs() <span class="keyword">as</span> capture:</div>
<div class="line">        response = await service_client.get(<span class="stringliteral">&#39;/logcapture&#39;</span>)</div>
<div class="line">        <span class="keyword">assert</span> response.status == 200</div>
<div class="line"> </div>
<div class="line">    records = capture.select(</div>
<div class="line">        text=<span class="stringliteral">&#39;Message to catpure&#39;</span>, link=response.headers[<span class="stringliteral">&#39;x-yarequestid&#39;</span>],</div>
<div class="line">    )</div>
<div class="line">    <span class="keyword">assert</span> len(records) == 1</div>
</div><!-- fragment --><p> Example on logs capture usage could be found here:</p>
<ul>
<li>C++ code: <a class="el" href="../../d5/dfa/samples_2testsuite-support_2logcapture_8cpp-example.html">samples/testsuite-support/logcapture.cpp</a></li>
<li>Testcase: <a class="el" href="../../d1/d98/samples_2testsuite-support_2tests_2test_logcapture_8py-example.html">samples/testsuite-support/tests/test_logcapture.py</a> </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- HTML footer for doxygen 1.8.13-->
<!-- start footer part -->
<hr class="footer"/>
<a id='page_edit' style="float:left; padding-left: 7pt;" href="#">⚒ Редактировать страницу</a>
<address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="../../doxygen.png" alt="doxygen"/>
</a> 1.8.17
</small></address>
<script type="text/javascript">
const LOWER_CASE_TRANSLITTERATION_MAPPING = {
    "а":"a", "б":"b", "в":"v", "г":"g", "д":"d", "е":"e", "ё":"jo", "ж":"zh",
    "з":"z", "и":"i", "й":"jj", "к":"k", "л":"l", "м":"m", "н":"n", "о":"o",
    "п":"p", "р":"r", "с":"s", "т":"t", "у":"u", "ф":"f", "х":"x", "ц":"c",
    "ч":"ch", "ш":"sh", "щ":"shh", "ъ":"\'", "ы":"y", "ь":"\'", "э":"je",
    "ю":"ju", "я":"ja"
};
const DOXYGEN_DIAMOND_STRING = '◆\u00A0' // ◆&nbsp;
function make_id(raw_id) {
    return raw_id.toLowerCase().split('').map(function (char) {
        return LOWER_CASE_TRANSLITTERATION_MAPPING[char] || char;
    }).join('').replace(/\W/g, '');
}
const html_escape = function () {
    const p = document.createElement('p');
    return function (text) {
        p.textContent = text;
        return p.innerHTML;
    };
}();
function setup_page_edit() {
    let href = window.location.href;
    const idx = href.indexOf('md_ru_');
    if (idx === -1) {
        $('#page_edit').hide();
        return;
    }
    href = href.substring(idx).split('.html')[0];
    href = href.split('#')[0];
    href = href.replace('md_ru_', 'https://wiki.yandex-team.ru/taxi/backend/');
    href = href.replaceAll('_', '/');
    $('#page_edit').attr("href", href + '/.edit');
}
function draw_toc() {
    let headers = $(':header');
    if (headers.length === 0) {
        return;
    }
    let sidenav_content = '<div id="mySidenav" class="sidenav">';
    sidenav_content += '<h2>Table of contents</h2>';
    headers.each(function() {
        let index = parseInt(this.nodeName.substring(1)) - 1;
        const header = $(this);
        let id = header.attr('id');
        if (!id) {
          id = make_id(header.text())
          header.attr('id', id);
        }
        let header_text = header.text()
        if (header_text.startsWith(DOXYGEN_DIAMOND_STRING)) {
            ++index;
            header_text = header_text.substring(DOXYGEN_DIAMOND_STRING.length);
        }
        sidenav_content += ''
          + '<a href="#' + id + '" style="padding-left: ' + index * 15 + 'px">'
          + '•&nbsp;' + html_escape(header_text)
          + '</a>'
        ;
        header.append(' <a class="hoverlink" href="#' + id + '">🔗</a>')
    });
    sidenav_content += '</div>';
    $(sidenav_content).insertAfter('.header');
}
function highlight_code() {
    if (window.location.href.indexOf("pp_source") !== -1
        || window.location.href.indexOf("cpp-example") !== -1) {
        // Header listing is already nicely highlighted by Doxygen
        return;
    }
    hljs.configure({
        tabReplace: '    ' // 4 spaces
    });
    hljs.registerAliases('py', {languageName: 'python'});
    hljs.registerAliases('sh', {languageName: 'shell'});
    hljs.registerAliases('bash', {languageName: 'shell'});
    hljs.registerAliases('yml', {languageName: 'yaml'});
    hljs.registerAliases('plain', {languageName: 'plaintext'});
    hljs.registerAliases('tskv', {languageName: 'plaintext'});
    $(".fragment").each(function() {
        const node = $(this);
        let data = '';
        let language = '';
        let requires_higlighting = true;
        node.children('div.line').each(function(i) {
            line = $(this).text();
            // Doxygen 1.8.11 workaround to remove line numbers.
            // No line numbers added in Doxygen 1.8.13
            line = line.replace(/^ *\d+\xA0/, '');
            if (i === 0) {
                line = line.trimLeft().replace(/^# /, '');
                if (line === 'autodetect') {
                    return true;
                } else if (hljs.getLanguage(line)) {
                    language = line;
                    return true;
                } else {
                    requires_higlighting = false;
                    return false;
                }
            }
            data += line + '\n';
        });
        if (requires_higlighting === false) {
            return;
        }
        if (language !== '') {
            data = hljs.highlight(language, data).value;
        } else {
            data = hljs.highlightAuto(data).value;
        }
        node.replaceWith('<div class="fragment"><pre>' + data + '</pre></div>');
    });
}
function setup_if_landing() {
    if (document.getElementById('landing_logo_id') === null) {
        return false;
    }
    $('#titlearea').hide();
    const main_nav = $('#main-nav')
    main_nav.addClass('main-nav-landing');
    main_nav.append('<hr>');
    $('.header').hide();
    $('body').css('background-color', 'black');
    $('#page_edit').hide();
    return true;
}
function sticky_menu() {
    const main_nav = $('#main-nav');
    const menu_y_position = 94;
    const search_results_window = $('#MSearchResultsWindow');
    var menu_is_sticky = false;
    const stick = function () {
        if ($(this).scrollTop() > menu_y_position) {
            if (menu_is_sticky) return;
            search_results_window.addClass('stickySearchResults');
            main_nav.addClass('stickyHeader');
            menu_is_sticky = true;
        } else {
            if (!menu_is_sticky) return;
            search_results_window.removeClass('stickySearchResults');
            // 'top' property of the results window is computed by Doxygen JS
            // and it may give bad results if the computation is invoked at the
            // middle of the page.
            //
            // Hiding the window. Doxygen will recompute and show it on new
            // user input.
            search_results_window.hide();
            main_nav.removeClass('stickyHeader');
            menu_is_sticky = false;
        }
    };
    stick();  // on page refresh draw the menu on a right position
    $(window).on("scroll", stick);
}
function telegram_channel_language() {
  if (/^ru/.test(navigator.language)) {
    const channel = $('#telegram_channel');
    if (channel) {
      channel.attr('href', 'https://t.me/+AdadhDPVG5xhNWRi');
    }
  }
}
$(function() {
    if (setup_if_landing()) return;
    draw_toc();
    highlight_code();
    setup_page_edit();
    telegram_channel_language();
    sticky_menu();
});
</script>
</body>
</html>
