<!-- HTML header for doxygen 1.8.13-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<link rel="icon" href="../../favicon.svg">
<title>userver: Pre-caching data from HTTP remote</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<link rel="stylesheet" href="../../doxygen-like.css">
<script src="../../highlight.pack.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../customdoxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0" style="width: 100%;">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><a id='logo-anchor' href="../../index.html"><img alt="Logo" src="../../logo.svg"/></a></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname"><a class="titlelink" href="../../index.html">userver
   </a>
   </div>
   <div id="projectbrief"><a class="titlelink" href="../../index.html">C++ Async Framework (beta)</a></div>
  </td>
  <td style="float: right; padding-right: 40px; padding-top: 15px;">
    <a href="https://github.com/userver-framework/userver" rel="noopener" target="_blank" class="titlelink">
      <img src="../../github_logo.svg" alt="Github"/>
    </a>
    &nbsp;
    <a href="https://t.me/+i3k5A6V0oFgwNmYy" rel="noopener" id='telegram_channel' target="_blank" class="titlelink">
      <img src="../../telegram_logo.svg" alt="Telegram"/>
    </a>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Pre-caching data from HTTP remote </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="autotoc_md285"></a>
Before you start</h1>
<p>Make sure that you can compile and run core tests and read a basic example <a class="el" href="../../d9/d72/md_en_userver_tutorial_hello_service.html">Writing your first HTTP server</a>.</p>
<h1><a class="anchor" id="autotoc_md286"></a>
Step by step guide</h1>
<p>Consider the case when you need to write an HTTP handler that greets a user. However, the localized strings are stored at some remote HTTP server, and those localizations rarely change. To reduce the network traffic and improve response times it is profitable to bulk retrieve the translations from remote and cache them in a local cache.</p>
<p>In this sample we show how to write and test a cache along with creating HTTP requests. If you wish to cache data from database prefer using <a class="el" href="../../d8/d01/md_en_userver_caches.html">cache specializations for DB</a>.</p>
<h2><a class="anchor" id="autotoc_md287"></a>
Remote HTTP server description</h2>
<p>For the purpose of this there is some HTTP server that has HTTP handler <code><a href="http://localhost:8090/v1/translations">http://localhost:8090/v1/translations</a></code>.</p>
<p>Handler returns all the available translations as JSON on GET: </p><div class="fragment"><div class="line">bash</div>
<div class="line">curl http://localhost:8090/v1/translations -s | jq</div>
<div class="line">{</div>
<div class="line">  &quot;content&quot;: {</div>
<div class="line">    &quot;hello&quot;: {</div>
<div class="line">      &quot;ru&quot;: &quot;Привет&quot;,</div>
<div class="line">      &quot;en&quot;: &quot;Hello&quot;</div>
<div class="line">    },</div>
<div class="line">    &quot;wellcome&quot;: {</div>
<div class="line">      &quot;ru&quot;: &quot;Добро пожаловать&quot;,</div>
<div class="line">      &quot;en&quot;: &quot;Wellcome&quot;</div>
<div class="line">    }</div>
<div class="line">  },</div>
<div class="line">  &quot;update_time&quot;: &quot;2021-11-01T12:00:00Z&quot;</div>
<div class="line">}</div>
</div><!-- fragment --><p>In case of query parameter "last_update" the handler returns only the changed translations since requested time: </p><div class="fragment"><div class="line">bash</div>
<div class="line">$ curl http://localhost:8090/v1/translations?last_update=2021-11-01T12:00:00Z -s | jq</div>
<div class="line">{</div>
<div class="line">  &quot;content&quot;: {</div>
<div class="line">    &quot;hello&quot;: {</div>
<div class="line">      &quot;ru&quot;: &quot;Приветище&quot;</div>
<div class="line">    }</div>
<div class="line">  },</div>
<div class="line">  &quot;update_time&quot;: &quot;2021-12-01T12:00:00Z&quot;</div>
<div class="line">}</div>
</div><!-- fragment --><p>We are planning to cache those translations in a std::unordered_map:</p>
<div class="fragment"><div class="line"><span class="keyword">namespace </span>samples::http_cache {</div>
<div class="line"> </div>
<div class="line"><span class="keyword">struct </span>KeyLang {</div>
<div class="line">  std::string key;</div>
<div class="line">  std::string language;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">struct </span>KeyLangEq {</div>
<div class="line">  <span class="keywordtype">bool</span> operator()(<span class="keyword">const</span> KeyLang&amp; x, <span class="keyword">const</span> KeyLang&amp; y) <span class="keyword">const</span> noexcept;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">struct </span>KeyLangHash {</div>
<div class="line">  <span class="keywordtype">bool</span> operator()(<span class="keyword">const</span> KeyLang&amp; x) <span class="keyword">const</span> noexcept;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">using</span> KeyLangToTranslation =</div>
<div class="line">    std::unordered_map&lt;KeyLang, std::string, KeyLangHash, KeyLangEq&gt;;</div>
<div class="line"> </div>
<div class="line">}  <span class="comment">// namespace samples::http_cache</span></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md288"></a>
Cache component</h2>
<p>Our cache <a class="el" href="../../d3/df4/md_en_userver_component-system.html">component</a> should have the following fields:</p><ul>
<li>Reference to HTTP client, that is required to make HTTP requests</li>
<li>URL to the incremental update handle</li>
<li>URL to the full update handle</li>
<li>String with last update time from remote. This string used only from the <a class="el" href="../../da/df8/classcache_1_1CacheUpdateTrait.html#aeedbce6882ed3f9e32ad663be728fe50" title="Forces a cache update of specified type.">components::CachingComponentBase::Update</a> overload and it is guaranteed <a class="el" href="../../d8/d01/md_en_userver_caches.html">that Update is not called concurrently</a>, so there is no need to protect it from concurrent access.</li>
</ul>
<div class="fragment"><div class="line"><span class="keyword">namespace </span>samples::http_cache {</div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>HttpCachedTranslations final</div>
<div class="line">    : <span class="keyword">public</span> <a class="code" href="../../df/dd1/classcomponents_1_1CachingComponentBase.html" title="Base class for caching components.">components::CachingComponentBase</a>&lt;KeyLangToTranslation&gt; {</div>
<div class="line"> <span class="keyword">public</span>:</div>
<div class="line">  <span class="keyword">static</span> constexpr std::string_view kName = <span class="stringliteral">&quot;cache-http-translations&quot;</span>;</div>
<div class="line"> </div>
<div class="line">  HttpCachedTranslations(<span class="keyword">const</span> <a class="code" href="../../db/dff/classcomponents_1_1ComponentConfig.html">components::ComponentConfig</a>&amp; config,</div>
<div class="line">                         <span class="keyword">const</span> <a class="code" href="../../da/db1/classcomponents_1_1ComponentContext.html" title="Class to retrieve other components.">components::ComponentContext</a>&amp; context);</div>
<div class="line">  ~HttpCachedTranslations() <span class="keyword">override</span>;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">void</span> Update(</div>
<div class="line">      <a class="code" href="../../db/d8d/namespacecache.html#a99d3f117ecf9ccf2816a2bb19c1ffce1" title="Type of CachingComponentBase update.">cache::UpdateType</a> type,</div>
<div class="line">      [[maybe_unused]] <span class="keyword">const</span> std::chrono::system_clock::time_point&amp; last_update,</div>
<div class="line">      [[maybe_unused]] <span class="keyword">const</span> std::chrono::system_clock::time_point&amp; now,</div>
<div class="line">      <a class="code" href="../../d8/db9/classcache_1_1UpdateStatisticsScope.html" title="Allows a specific cache to fill cache statistics during an Update">cache::UpdateStatisticsScope</a>&amp; stats_scope) <span class="keyword">override</span>;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">static</span> <a class="code" href="../../d1/d3e/structyaml__config_1_1Schema.html" title="JSON Schema-like type definition.">yaml_config::Schema</a> GetStaticConfigSchema();</div>
<div class="line"> </div>
<div class="line"> <span class="keyword">private</span>:</div>
<div class="line">  <a class="code" href="../../d5/dee/classclients_1_1http_1_1Client.html" title="HTTP client that returns a HTTP request builder from CreateRequest().">clients::http::Client</a>&amp; http_client_;</div>
<div class="line">  <span class="keyword">const</span> std::string translations_url_;</div>
<div class="line">  std::string last_update_remote_;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">struct </span>RemoteData {</div>
<div class="line">    std::string update_time;</div>
<div class="line">    KeyLangToTranslation content;</div>
<div class="line">  };</div>
<div class="line"> </div>
<div class="line">  RemoteData GetAllData() <span class="keyword">const</span>;</div>
<div class="line">  RemoteData GetUpdatedData() <span class="keyword">const</span>;</div>
<div class="line">  <span class="keyword">static</span> <span class="keywordtype">void</span> MergeDataInto(RemoteData&amp; data, std::string_view body);</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line">}  <span class="comment">// namespace samples::http_cache</span></div>
</div><!-- fragment --><p> To create a non <a class="el" href="../../d1/da0/md_en_userver_lru-cache.html">LRU cache</a> cache you have to derive from <a class="el" href="../../df/dd1/classcomponents_1_1CachingComponentBase.html" title="Base class for caching components.">components::CachingComponentBase</a>, call CacheUpdateTrait::StartPeriodicUpdates() at the component constructor and CacheUpdateTrait::StopPeriodicUpdates() at the destructor:</p>
<div class="fragment"><div class="line">HttpCachedTranslations::HttpCachedTranslations(</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="../../db/dff/classcomponents_1_1ComponentConfig.html">components::ComponentConfig</a>&amp; config,</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="../../da/db1/classcomponents_1_1ComponentContext.html" title="Class to retrieve other components.">components::ComponentContext</a>&amp; context)</div>
<div class="line">    : CachingComponentBase(config, context),</div>
<div class="line">      http_client_(</div>
<div class="line">          context.FindComponent&lt;<a class="code" href="../../d0/d1f/namespacecomponents.html" title="Contains functions and types to start a userver based service/tool.">components</a>::HttpClient&gt;().GetHttpClient()),</div>
<div class="line">      translations_url_(config[<span class="stringliteral">&quot;translations-url&quot;</span>].As&lt;std::string&gt;()) {</div>
<div class="line">  CacheUpdateTrait::StartPeriodicUpdates();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">HttpCachedTranslations::~HttpCachedTranslations() {</div>
<div class="line">  CacheUpdateTrait::StopPeriodicUpdates();</div>
<div class="line">}</div>
</div><!-- fragment --><p> The constructor initializes component fields with data from static configuration and with references to clients.</p>
<h2><a class="anchor" id="autotoc_md289"></a>
Update</h2>
<p>Depending on cache configuration settings the overloaded Update function is periodically called with different options:</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> HttpCachedTranslations::Update(</div>
<div class="line">    <a class="code" href="../../db/d8d/namespacecache.html#a99d3f117ecf9ccf2816a2bb19c1ffce1" title="Type of CachingComponentBase update.">cache::UpdateType</a> type,</div>
<div class="line">    [[maybe_unused]] <span class="keyword">const</span> std::chrono::system_clock::time_point&amp; last_update,</div>
<div class="line">    [[maybe_unused]] <span class="keyword">const</span> std::chrono::system_clock::time_point&amp; now,</div>
<div class="line">    <a class="code" href="../../d8/db9/classcache_1_1UpdateStatisticsScope.html" title="Allows a specific cache to fill cache statistics during an Update">cache::UpdateStatisticsScope</a>&amp; stats_scope) {</div>
<div class="line">  RemoteData result;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">switch</span> (type) {</div>
<div class="line">    <span class="keywordflow">case</span> <a class="code" href="../../db/d8d/namespacecache.html#a99d3f117ecf9ccf2816a2bb19c1ffce1aa60924e124da4d51bd4dc74c8f85b158" title="requests all the items, starting from scratch">cache::UpdateType::kFull</a>:</div>
<div class="line">      result = GetAllData();</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">case</span> <a class="code" href="../../db/d8d/namespacecache.html#a99d3f117ecf9ccf2816a2bb19c1ffce1a4461e3132c6a68cc061f851d6b53fc15" title="requests only newly updated items">cache::UpdateType::kIncremental</a>:</div>
<div class="line">      result = GetUpdatedData();</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">default</span>:</div>
<div class="line">      <a class="code" href="../../d2/d54/assert_8hpp.html#abf42436fd89fea4f612dd97bedbf83ac" title="Assertion macro that aborts execution in DEBUG builds and does nothing in release builds.">UASSERT</a>(<span class="keyword">false</span>);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keyword">auto</span> size = result.content.size();</div>
<div class="line">  Set(std::move(result.content));</div>
<div class="line">  last_update_remote_ = std::move(result.update_time);</div>
<div class="line">  stats_scope.<a class="code" href="../../d8/db9/classcache_1_1UpdateStatisticsScope.html#a466304bf4dd8987646c864dd7a4328ae" title="Mark that the Update has finished with changes.">Finish</a>(size);</div>
<div class="line">}</div>
</div><!-- fragment --><p> In this sample there are full and incremental updates, implemented in GetAllData() and GetUpdatedData() respectively.</p>
<p>At the end of the Update function the components::CachingComponentBase::Set() invocation stores data as a new cache.</p>
<p>Update time from remote stored into <code>last_update_remote_</code>. Clocks on different hosts are usually out of sync, so it is better to store the remote time if possible, rather than using a local times from <code>last_update</code> and <code>now</code> input parameters.</p>
<h2><a class="anchor" id="autotoc_md290"></a>
Data retrieval</h2>
<p>To make an HTTP request call <a class="el" href="../../d5/dee/classclients_1_1http_1_1Client.html#a71b178762e8a8b9857d1a22902ae9b5b" title="Returns a HTTP request builder type with preset values of User-Agent, Proxy and some of the Testsuite...">clients::http::Client::CreateRequest()</a> to get an instance of <a class="el" href="../../de/df5/classclients_1_1http_1_1Request.html" title="Class for creating and performing new http requests.">clients::http::Request</a> builder. Work with builder is quite straightforward:</p>
<div class="fragment"><div class="line">HttpCachedTranslations::RemoteData HttpCachedTranslations::GetAllData()<span class="keyword"> const </span>{</div>
<div class="line">  RemoteData result;</div>
<div class="line">  <span class="keyword">auto</span> response =</div>
<div class="line">      http_client_.CreateRequest()</div>
<div class="line">          -&gt;get(translations_url_)  <span class="comment">// HTTP GET translations_url_ URL</span></div>
<div class="line">          -&gt;retry(2)                <span class="comment">// retry once in case of error</span></div>
<div class="line">          -&gt;timeout(std::chrono::milliseconds{500})</div>
<div class="line">          -&gt;perform();  <span class="comment">// start performing the request</span></div>
<div class="line">  response-&gt;raise_for_status();</div>
<div class="line"> </div>
<div class="line">  MergeDataInto(result, response-&gt;body_view());</div>
<div class="line">  <span class="keywordflow">return</span> result;</div>
<div class="line">}</div>
</div><!-- fragment --><p> HTTP requests for incremental update differ only in URL and query parameter <code>last_update</code>:</p>
<div class="fragment"><div class="line">HttpCachedTranslations::RemoteData HttpCachedTranslations::GetUpdatedData()<span class="keyword"></span></div>
<div class="line"><span class="keyword">    const </span>{</div>
<div class="line">  RemoteData result;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keyword">auto</span> url =</div>
<div class="line">      <a class="code" href="../../d3/d69/namespacehttp.html#a8dbec47df1105b1e4628448bd4f8a382" title="Make an URL with query arguments.">http::MakeUrl</a>(translations_url_, {{<span class="stringliteral">&quot;last_update&quot;</span>, last_update_remote_}});</div>
<div class="line">  <span class="keyword">auto</span> response = http_client_.CreateRequest()</div>
<div class="line">                      -&gt;get(url)</div>
<div class="line">                      -&gt;retry(2)</div>
<div class="line">                      -&gt;timeout(std::chrono::milliseconds{500})</div>
<div class="line">                      -&gt;perform();</div>
<div class="line">  response-&gt;raise_for_status();</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keyword">auto</span> snapshot = Get();  <span class="comment">// getting smart pointer to a shared cache data</span></div>
<div class="line">  result.content = *snapshot;   <span class="comment">// copying the shared data</span></div>
<div class="line">  MergeDataInto(result, response-&gt;body_view());</div>
<div class="line">  <span class="keywordflow">return</span> result;</div>
<div class="line">}</div>
</div><!-- fragment --><p> Both handlers return data in the same format, so we parse both responses using <code>MergeDataInto</code>:</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> HttpCachedTranslations::MergeDataInto(</div>
<div class="line">    HttpCachedTranslations::RemoteData&amp; data, std::string_view body) {</div>
<div class="line">  <a class="code" href="../../de/d91/classformats_1_1json_1_1Value.html" title="Non-mutable JSON value representation.">formats::json::Value</a> json = <a class="code" href="../../de/da1/namespaceformats_1_1json.html#aebd74445be0a82a8db7976c19324f098" title="Parse JSON from string.">formats::json::FromString</a>(body);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span> (json.<a class="code" href="../../de/d91/classformats_1_1json_1_1Value.html#a6829008957d6d7a0579a878db3d35598" title="Returns whether the array or object is empty. Returns true for null.">IsEmpty</a>()) {</div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; [key, value] : Items(json[<span class="stringliteral">&quot;content&quot;</span>])) {</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; [lang, text] : Items(value)) {</div>
<div class="line">      data.content.insert_or_assign(KeyLang{key, lang}, text.As&lt;std::string&gt;());</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  data.update_time = json[<span class="stringliteral">&quot;update_time&quot;</span>].<a class="code" href="../../de/d91/classformats_1_1json_1_1Value.html#a4383138b64646d372ab3990e38e2fc62" title="Returns value of *this converted to T.">As</a>&lt;std::string&gt;();</div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md291"></a>
Static configuration</h2>
<p>To configure the new cache component provide its own options, options from <a class="el" href="../../df/dd1/classcomponents_1_1CachingComponentBase.html" title="Base class for caching components.">components::CachingComponentBase</a>:</p>
<div class="fragment"><div class="line"># yaml</div>
<div class="line">components_manager:</div>
<div class="line">    components:                       # Configuring components that were registered via component_list</div>
<div class="line">        cache-http-translations:</div>
<div class="line">            translations-url: &#39;mockserver/v1/translations&#39;  # Some other microservice listens on this URL</div>
<div class="line"> </div>
<div class="line">            update-types: full-and-incremental</div>
<div class="line">            full-update-interval: 1h</div>
<div class="line">            update-interval: 15m</div>
</div><!-- fragment --><p> Options for dependent components <a class="el" href="../../dd/d5a/classcomponents_1_1HttpClient.html" title="Component that manages clients::http::Client.">components::HttpClient</a>, <a class="el" href="../../d9/de2/classcomponents_1_1TestsuiteSupport.html" title="Testsuite support component.">components::TestsuiteSupport</a> and support handler <a class="el" href="../../d5/ded/classserver_1_1handlers_1_1TestsControl.html" title="Handler that allows to control the behavior of server from tests.">server::handlers::TestsControl</a> should be provided:</p>
<div class="fragment"><div class="line">        http-client:</div>
<div class="line">            fs-task-processor: fs-task-processor</div>
<div class="line"> </div>
<div class="line">        testsuite-support:</div>
<div class="line">        tests-control:</div>
<div class="line">            # Some options from server::handlers::HttpHandlerBase</div>
<div class="line">            path: /tests/control</div>
<div class="line">            method: POST</div>
<div class="line">            task_processor: main-task-processor</div>
<div class="line"> </div>
<div class="line">        server:</div>
<div class="line">            # ...</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md292"></a>
Dynamic configuration</h2>
<p>Dynamic configuration is close to the basic configuration from <a class="el" href="../../d9/d72/md_en_userver_tutorial_hello_service.html">Writing your first HTTP server</a> but should have additional options for HTTP client: <a class="el" href="../../d3/d25/samples_2http_caching_2dynamic_config_fallback_8json-example.html">samples/http_caching/dynamic_config_fallback.json</a></p>
<p>All the values are described in at <a class="el" href="../../dd/d2c/md_en_schemas_dynamic_configs.html">Dynamic configs</a>.</p>
<p>A production ready service would dynamically retrieve the above options at runtime from a configuration service. See <a class="el" href="../../dd/d69/md_en_userver_tutorial_config_service.html">Writing your own configs server</a> for insights on how to change the above options on the fly, without restarting the service.</p>
<h2><a class="anchor" id="autotoc_md293"></a>
Cache component usage</h2>
<p>Now the cache could be used just as any other component. For example, a handler could get a reference to the cache and use it in <code>HandleRequestThrow</code>:</p>
<div class="fragment"><div class="line"><span class="keyword">class </span>GreetUser final : <span class="keyword">public</span> <a class="code" href="../../d6/d36/classserver_1_1handlers_1_1HttpHandlerBase.html" title="Base class for all the Userver HTTP Handlers.">server::handlers::HttpHandlerBase</a> {</div>
<div class="line"> <span class="keyword">public</span>:</div>
<div class="line">  <span class="keyword">static</span> constexpr std::string_view kName = <span class="stringliteral">&quot;handler-greet-user&quot;</span>;</div>
<div class="line"> </div>
<div class="line">  GreetUser(<span class="keyword">const</span> <a class="code" href="../../db/dff/classcomponents_1_1ComponentConfig.html">components::ComponentConfig</a>&amp; config,</div>
<div class="line">            <span class="keyword">const</span> <a class="code" href="../../da/db1/classcomponents_1_1ComponentContext.html" title="Class to retrieve other components.">components::ComponentContext</a>&amp; context)</div>
<div class="line">      : HttpHandlerBase(config, context),</div>
<div class="line">        cache_(context.FindComponent&lt;HttpCachedTranslations&gt;()) {}</div>
<div class="line"> </div>
<div class="line">  std::string HandleRequestThrow(</div>
<div class="line">      <span class="keyword">const</span> <a class="code" href="../../d3/d44/classserver_1_1http_1_1HttpRequest.html" title="HTTP Request data.">server::http::HttpRequest</a>&amp; request,</div>
<div class="line">      <a class="code" href="../../de/df6/classserver_1_1request_1_1RequestContext.html" title="Stores request-specific data during request processing.">server::request::RequestContext</a>&amp;)<span class="keyword"> const override </span>{</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">auto</span> cache_snapshot = cache_.Get();</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">using</span> samples::http_cache::KeyLang;</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">auto</span>&amp; hello = cache_snapshot-&gt;at(KeyLang{<span class="stringliteral">&quot;hello&quot;</span>, <span class="stringliteral">&quot;ru&quot;</span>});</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">auto</span>&amp; welcome = cache_snapshot-&gt;at(KeyLang{<span class="stringliteral">&quot;welcome&quot;</span>, <span class="stringliteral">&quot;ru&quot;</span>});</div>
<div class="line">    <span class="keywordflow">return</span> fmt::format(<span class="stringliteral">&quot;{}, {}! {}&quot;</span>, hello, request.<a class="code" href="../../d3/d44/classserver_1_1http_1_1HttpRequest.html#ad6c86e51f02572fb76ae9a8d58376884">GetArg</a>(<span class="stringliteral">&quot;username&quot;</span>),</div>
<div class="line">                       welcome);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> <span class="keyword">private</span>:</div>
<div class="line">  samples::http_cache::HttpCachedTranslations&amp; cache_;</div>
<div class="line">};</div>
</div><!-- fragment --><p> Note that the cache is concurrency safe <a class="el" href="../../d3/df4/md_en_userver_component-system.html">as all the components</a>.</p>
<h2><a class="anchor" id="autotoc_md294"></a>
int main()</h2>
<p>Finally, after writing down the dynamic configuration values into file at <code>taxi-config-fallbacks.fallback-path</code>, we add our component to the <code><a class="el" href="../../dd/d1c/group__userver__components.html#ga44510c5120b67bd36f0ff9f845c68280" title="Returns a list of components to start a basic HTTP server.">components::MinimalServerComponentList()</a></code>, and start the server with static configuration <code>kStaticConfig</code>.</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span>* argv[]) {</div>
<div class="line">  <span class="keyword">const</span> <span class="keyword">auto</span> component_list =</div>
<div class="line">      <a class="code" href="../../dd/d1c/group__userver__components.html#ga44510c5120b67bd36f0ff9f845c68280" title="Returns a list of components to start a basic HTTP server.">components::MinimalServerComponentList</a>()</div>
<div class="line">          .Append&lt;samples::http_cache::HttpCachedTranslations&gt;()</div>
<div class="line">          .Append&lt;samples::http_cache::GreetUser&gt;()</div>
<div class="line">          .Append&lt;<a class="code" href="../../d9/de2/classcomponents_1_1TestsuiteSupport.html" title="Testsuite support component.">components::TestsuiteSupport</a>&gt;()</div>
<div class="line">          .Append&lt;server::handlers::TestsControl&gt;()</div>
<div class="line">          .Append&lt;<a class="code" href="../../dd/d5a/classcomponents_1_1HttpClient.html" title="Component that manages clients::http::Client.">components::HttpClient</a>&gt;();</div>
<div class="line">  <span class="keywordflow">return</span> <a class="code" href="../../d6/d84/namespaceutils.html#a40294f3ed93c7f13cb2c814d70134820">utils::DaemonMain</a>(argc, argv, component_list);</div>
<div class="line">}</div>
</div><!-- fragment --> <h2><a class="anchor" id="autotoc_md295"></a>
Build</h2>
<p>To build the sample, execute the following build steps at the userver root directory: </p><div class="fragment"><div class="line">mkdir build_release</div>
<div class="line">cd build_release</div>
<div class="line">cmake -DCMAKE_BUILD_TYPE=Release ..</div>
<div class="line">make userver-samples-http_caching</div>
</div><!-- fragment --><p>Start the server by running <code>./samples/http_caching/userver-samples-http_caching</code>. Not that you need a running translations service with bulk handlers. You could use the <a class="el" href="../../d7/d8d/md_en_userver_tutorial_mongo_service.html">mongo service</a> for that purpose.</p>
<p>Now you can send a request to your server from another terminal: </p><div class="fragment"><div class="line">bash</div>
<div class="line">$ curl -X POST http://localhost:8089/samples/greet?username=Dear+Developer  -i</div>
<div class="line">HTTP/1.1 200 OK</div>
<div class="line">Date: Thu, 09 Dec 2021 17:01:44 UTC</div>
<div class="line">Content-Type: text/html; charset=utf-8</div>
<div class="line">X-YaRequestId: 94193f99ebf94eb58252139f2e9dace4</div>
<div class="line">X-YaSpanId: 4e17e02dfa7b8322</div>
<div class="line">X-YaTraceId: 306d2d54fd0543c09376a5c4bb120a88</div>
<div class="line">Server: userver/1.0.0 (20211209085954; rv:d05d059a3)</div>
<div class="line">Connection: keep-alive</div>
<div class="line">Content-Length: 61</div>
<div class="line"> </div>
<div class="line">Привет, Dear Developer! Добро пожаловать</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md296"></a>
Auto testing</h2>
<p>The <a class="el" href="../../d5/ded/classserver_1_1handlers_1_1TestsControl.html" title="Handler that allows to control the behavior of server from tests.">server::handlers::TestsControl</a> and <a class="el" href="../../d9/de2/classcomponents_1_1TestsuiteSupport.html" title="Testsuite support component.">components::TestsuiteSupport</a> components among other things provide necessary control over the caches. You can stop/start periodic updates or even force updates of caches by HTTP requests to the <a class="el" href="../../d5/ded/classserver_1_1handlers_1_1TestsControl.html" title="Handler that allows to control the behavior of server from tests.">server::handlers::TestsControl</a> handler.</p>
<p>For example the following JSON forces incremental update of the <code>cache-http-translations</code> cache: </p><div class="fragment"><div class="line">json</div>
<div class="line">{&quot;invalidate_caches&quot;: {</div>
<div class="line">    &quot;update_type&quot;: &quot;incremental&quot;,</div>
<div class="line">    &quot;names&quot;: [&quot;cache-http-translations&quot;]</div>
<div class="line">}}</div>
</div><!-- fragment --><p>Fortunately, the <a class="el" href="../../d1/dd6/md_en_userver_functional_testing.html">testsuite API</a> provides all the required functionality via simpler to use Python functions.</p>
<h2><a class="anchor" id="autotoc_md297"></a>
Functional testing</h2>
<p><a class="el" href="../../d1/dd6/md_en_userver_functional_testing.html">Functional tests</a> for the service could be implemented using the testsuite. To do that you have to:</p>
<ul>
<li>Mock the translations service data: <div class="fragment"><div class="line">@pytest.fixture</div>
<div class="line"><span class="keyword">def </span>translations():</div>
<div class="line">    <span class="keywordflow">return</span> {</div>
<div class="line">        <span class="stringliteral">&#39;hello&#39;</span>: {<span class="stringliteral">&#39;en&#39;</span>: <span class="stringliteral">&#39;hello&#39;</span>, <span class="stringliteral">&#39;ru&#39;</span>: <span class="stringliteral">&#39;Привет&#39;</span>},</div>
<div class="line">        <span class="stringliteral">&#39;welcome&#39;</span>: {<span class="stringliteral">&#39;ru&#39;</span>: <span class="stringliteral">&#39;Добро пожаловать&#39;</span>, <span class="stringliteral">&#39;en&#39;</span>: <span class="stringliteral">&#39;Welcome&#39;</span>},</div>
<div class="line">    }</div>
</div><!-- fragment --></li>
<li>Mock the translations service API: <div class="fragment"><div class="line">@pytest.fixture(autouse=<span class="keyword">True</span>)</div>
<div class="line"><span class="keyword">def </span>mock_translations(mockserver, translations, mocked_time):</div>
<div class="line">    @mockserver.json_handler(<span class="stringliteral">&#39;/v1/translations&#39;</span>)</div>
<div class="line">    <span class="keyword">def </span>mock(request):</div>
<div class="line">        <span class="keywordflow">return</span> {</div>
<div class="line">            <span class="stringliteral">&#39;content&#39;</span>: translations,</div>
<div class="line">            <span class="stringliteral">&#39;update_time&#39;</span>: utils.timestring(mocked_time.now()),</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> mock</div>
</div><!-- fragment --></li>
<li>Teach testsuite how to patch the service config to use the mocked URL: <div class="fragment"><div class="line">USERVER_CONFIG_HOOKS = [<span class="stringliteral">&#39;userver_config_translations&#39;</span>]</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">@pytest.fixture(scope=<span class="stringliteral">&#39;session&#39;</span>)</div>
<div class="line"><span class="keyword">def </span>userver_config_translations(mockserver_info):</div>
<div class="line">    <span class="keyword">def </span>do_patch(config_yaml, config_vars):</div>
<div class="line">        components = config_yaml[<span class="stringliteral">&#39;components_manager&#39;</span>][<span class="stringliteral">&#39;components&#39;</span>]</div>
<div class="line">        components[<span class="stringliteral">&#39;cache-http-translations&#39;</span>][</div>
<div class="line">            <span class="stringliteral">&#39;translations-url&#39;</span></div>
<div class="line">        ] = mockserver_info.url(<span class="stringliteral">&#39;v1/translations&#39;</span>)</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> do_patch</div>
</div><!-- fragment --></li>
<li>Write the test: <div class="fragment"><div class="line">async <span class="keyword">def </span>test_http_caching(service_client, translations, mocked_time):</div>
<div class="line">    response = await service_client.post(</div>
<div class="line">        <span class="stringliteral">&#39;/samples/greet&#39;</span>, params={<span class="stringliteral">&#39;username&#39;</span>: <span class="stringliteral">&#39;дорогой разработчик&#39;</span>},</div>
<div class="line">    )</div>
<div class="line">    <span class="keyword">assert</span> response.status == 200</div>
<div class="line">    <span class="keyword">assert</span> response.text == <span class="stringliteral">&#39;Привет, дорогой разработчик! Добро пожаловать&#39;</span></div>
<div class="line"> </div>
<div class="line">    translations[<span class="stringliteral">&#39;hello&#39;</span>][<span class="stringliteral">&#39;ru&#39;</span>] = <span class="stringliteral">&#39;Приветище&#39;</span></div>
<div class="line"> </div>
<div class="line">    mocked_time.sleep(10)</div>
<div class="line">    await service_client.invalidate_caches()</div>
<div class="line"> </div>
<div class="line">    response = await service_client.post(</div>
<div class="line">        <span class="stringliteral">&#39;/samples/greet&#39;</span>, params={<span class="stringliteral">&#39;username&#39;</span>: <span class="stringliteral">&#39;дорогой разработчик&#39;</span>},</div>
<div class="line">    )</div>
<div class="line">    <span class="keyword">assert</span> response.status == 200</div>
<div class="line">    <span class="keyword">assert</span> response.text == <span class="stringliteral">&#39;Приветище, дорогой разработчик! Добро пожаловать&#39;</span></div>
</div><!-- fragment --></li>
</ul>
<h1><a class="anchor" id="autotoc_md298"></a>
Full sources</h1>
<p>See the full example:</p><ul>
<li><a class="el" href="../../d3/db5/samples_2http_caching_2http_caching_8cpp-example.html">samples/http_caching/http_caching.cpp</a></li>
<li><a class="el" href="../../d4/d04/samples_2http_caching_2static_config_8yaml-example.html">samples/http_caching/static_config.yaml</a></li>
<li><a class="el" href="../../d3/d25/samples_2http_caching_2dynamic_config_fallback_8json-example.html">samples/http_caching/dynamic_config_fallback.json</a></li>
<li><a class="el" href="../../d6/dec/samples_2http_caching_2CMakeLists_8txt-example.html">samples/http_caching/CMakeLists.txt</a></li>
<li><a class="el" href="../../dd/df0/samples_2http_caching_2tests_2conftest_8py-example.html">samples/http_caching/tests/conftest.py</a></li>
<li><a class="el" href="../../d9/d0d/samples_2http_caching_2tests_2test_http_caching_8py-example.html">samples/http_caching/tests/test_http_caching.py</a> </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- HTML footer for doxygen 1.8.13-->
<!-- start footer part -->
<hr class="footer"/>
<a id='page_edit' style="float:left; padding-left: 7pt;" href="#">⚒ Редактировать страницу</a>
<address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="../../doxygen.png" alt="doxygen"/>
</a> 1.8.17
</small></address>
<script type="text/javascript">
const LOWER_CASE_TRANSLITTERATION_MAPPING = {
    "а":"a", "б":"b", "в":"v", "г":"g", "д":"d", "е":"e", "ё":"jo", "ж":"zh",
    "з":"z", "и":"i", "й":"jj", "к":"k", "л":"l", "м":"m", "н":"n", "о":"o",
    "п":"p", "р":"r", "с":"s", "т":"t", "у":"u", "ф":"f", "х":"x", "ц":"c",
    "ч":"ch", "ш":"sh", "щ":"shh", "ъ":"\'", "ы":"y", "ь":"\'", "э":"je",
    "ю":"ju", "я":"ja"
};
const DOXYGEN_DIAMOND_STRING = '◆\u00A0' // ◆&nbsp;
function make_id(raw_id) {
    return raw_id.toLowerCase().split('').map(function (char) {
        return LOWER_CASE_TRANSLITTERATION_MAPPING[char] || char;
    }).join('').replace(/\W/g, '');
}
const html_escape = function () {
    const p = document.createElement('p');
    return function (text) {
        p.textContent = text;
        return p.innerHTML;
    };
}();
function setup_page_edit() {
    let href = window.location.href;
    const idx = href.indexOf('md_ru_');
    if (idx === -1) {
        $('#page_edit').hide();
        return;
    }
    href = href.substring(idx).split('.html')[0];
    href = href.split('#')[0];
    href = href.replace('md_ru_', 'https://wiki.yandex-team.ru/taxi/backend/');
    href = href.replaceAll('_', '/');
    $('#page_edit').attr("href", href + '/.edit');
}
function draw_toc() {
    let headers = $(':header');
    if (headers.length === 0) {
        return;
    }
    let sidenav_content = '<div id="mySidenav" class="sidenav">';
    sidenav_content += '<h2>Table of contents</h2>';
    headers.each(function() {
        let index = parseInt(this.nodeName.substring(1)) - 1;
        const header = $(this);
        let id = header.attr('id');
        if (!id) {
          id = make_id(header.text())
          header.attr('id', id);
        }
        let header_text = header.text()
        if (header_text.startsWith(DOXYGEN_DIAMOND_STRING)) {
            ++index;
            header_text = header_text.substring(DOXYGEN_DIAMOND_STRING.length);
        }
        sidenav_content += ''
          + '<a href="#' + id + '" style="padding-left: ' + index * 15 + 'px">'
          + '•&nbsp;' + html_escape(header_text)
          + '</a>'
        ;
        header.append(' <a class="hoverlink" href="#' + id + '">🔗</a>')
    });
    sidenav_content += '</div>';
    $(sidenav_content).insertAfter('.header');
}
function highlight_code() {
    if (window.location.href.indexOf("pp_source") !== -1
        || window.location.href.indexOf("cpp-example") !== -1) {
        // Header listing is already nicely highlighted by Doxygen
        return;
    }
    hljs.configure({
        tabReplace: '    ' // 4 spaces
    });
    hljs.registerAliases('py', {languageName: 'python'});
    hljs.registerAliases('sh', {languageName: 'shell'});
    hljs.registerAliases('bash', {languageName: 'shell'});
    hljs.registerAliases('yml', {languageName: 'yaml'});
    hljs.registerAliases('plain', {languageName: 'plaintext'});
    hljs.registerAliases('tskv', {languageName: 'plaintext'});
    $(".fragment").each(function() {
        const node = $(this);
        let data = '';
        let language = '';
        let requires_higlighting = true;
        node.children('div.line').each(function(i) {
            line = $(this).text();
            // Doxygen 1.8.11 workaround to remove line numbers.
            // No line numbers added in Doxygen 1.8.13
            line = line.replace(/^ *\d+\xA0/, '');
            if (i === 0) {
                line = line.trimLeft().replace(/^# /, '');
                if (line === 'autodetect') {
                    return true;
                } else if (hljs.getLanguage(line)) {
                    language = line;
                    return true;
                } else {
                    requires_higlighting = false;
                    return false;
                }
            }
            data += line + '\n';
        });
        if (requires_higlighting === false) {
            return;
        }
        if (language !== '') {
            data = hljs.highlight(language, data).value;
        } else {
            data = hljs.highlightAuto(data).value;
        }
        node.replaceWith('<div class="fragment"><pre>' + data + '</pre></div>');
    });
}
function setup_if_landing() {
    if (document.getElementById('landing_logo_id') === null) {
        return false;
    }
    $('#titlearea').hide();
    const main_nav = $('#main-nav')
    main_nav.addClass('main-nav-landing');
    main_nav.append('<hr>');
    $('.header').hide();
    $('body').css('background-color', 'black');
    $('#page_edit').hide();
    return true;
}
function sticky_menu() {
    const main_nav = $('#main-nav');
    const menu_y_position = 94;
    const search_results_window = $('#MSearchResultsWindow');
    var menu_is_sticky = false;
    const stick = function () {
        if ($(this).scrollTop() > menu_y_position) {
            if (menu_is_sticky) return;
            search_results_window.addClass('stickySearchResults');
            main_nav.addClass('stickyHeader');
            menu_is_sticky = true;
        } else {
            if (!menu_is_sticky) return;
            search_results_window.removeClass('stickySearchResults');
            // 'top' property of the results window is computed by Doxygen JS
            // and it may give bad results if the computation is invoked at the
            // middle of the page.
            //
            // Hiding the window. Doxygen will recompute and show it on new
            // user input.
            search_results_window.hide();
            main_nav.removeClass('stickyHeader');
            menu_is_sticky = false;
        }
    };
    stick();  // on page refresh draw the menu on a right position
    $(window).on("scroll", stick);
}
function telegram_channel_language() {
  if (/^ru/.test(navigator.language)) {
    const channel = $('#telegram_channel');
    if (channel) {
      channel.attr('href', 'https://t.me/+AdadhDPVG5xhNWRi');
    }
  }
}
$(function() {
    if (setup_if_landing()) return;
    draw_toc();
    highlight_code();
    setup_page_edit();
    telegram_channel_language();
    sticky_menu();
});
</script>
</body>
</html>
