<!-- HTML header for doxygen 1.8.13-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<link rel="icon" href="../../favicon.svg">
<title>userver: PostgreSQL service</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<link rel="stylesheet" href="../../doxygen-like.css">
<script src="../../highlight.pack.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../customdoxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0" style="width: 100%;">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><a id='logo-anchor' href="../../index.html"><img alt="Logo" src="../../logo.svg"/></a></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname"><a class="titlelink" href="../../index.html">userver
   </a>
   </div>
   <div id="projectbrief"><a class="titlelink" href="../../index.html">C++ Async Framework (beta)</a></div>
  </td>
  <td style="float: right; padding-right: 40px; padding-top: 15px;">
    <a href="https://github.com/userver-framework/userver" rel="noopener" target="_blank" class="titlelink">
      <img src="../../github_logo.svg" alt="Github"/>
    </a>
    &nbsp;
    <a href="https://t.me/+i3k5A6V0oFgwNmYy" rel="noopener" id='telegram_channel' target="_blank" class="titlelink">
      <img src="../../telegram_logo.svg" alt="Telegram"/>
    </a>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">PostgreSQL service </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="autotoc_md312"></a>
Before you start</h1>
<p>Make sure that you can compile and run core tests and read a basic example <a class="el" href="../../d9/d72/md_en_userver_tutorial_hello_service.html">Writing your first HTTP server</a>.</p>
<h1><a class="anchor" id="autotoc_md313"></a>
Step by step guide</h1>
<p>Microservices that have state often work with database to store their data and replicate that state across instances of the microservice. In this tutorial we will write a service that is a simple key-value storage on top of PostgreSQL database. The service would have the following Rest API:</p><ul>
<li>HTTP POST by path '/v1/key-value' with query parameters 'key' and 'value' stores the provided key and value or return an existing value for the key</li>
<li>HTTP GET by path '/v1/key-value' with query parameter 'key' returns the value if it exists</li>
<li>HTTP DELETE by path '/v1/key-value' with query parameter 'key' deletes the key if it exists and returns number of deleted keys</li>
</ul>
<h2><a class="anchor" id="autotoc_md314"></a>
HTTP handler component</h2>
<p>Like in <a class="el" href="../../d9/d72/md_en_userver_tutorial_hello_service.html">Writing your first HTTP server</a> we create a component for handling HTTP requests:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="../../db/dbf/minimal__server__component__list_8hpp.html" title="Returns a list of components to start a basic HTTP server.">userver/components/minimal_server_component_list.hpp</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="../../d4/df6/http__handler__base_8hpp.html" title="Base class for all the Userver HTTP Handlers.">userver/server/handlers/http_handler_base.hpp</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="../../d7/de0/daemon__run_8hpp.html" title="Functions to start a daemon with specified components list.">userver/utils/daemon_run.hpp</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="../../de/dd3/postgresql_2include_2userver_2storages_2postgres_2cluster_8hpp.html" title="Interface for executing queries on a cluster of PostgreSQL servers.">userver/storages/postgres/cluster.hpp</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="../../df/d08/postgresql_2include_2userver_2storages_2postgres_2component_8hpp.html" title="PosgreSQL client component.">userver/storages/postgres/component.hpp</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">namespace </span>samples::pg {</div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>KeyValue final : <span class="keyword">public</span> <a class="code" href="../../d6/d36/classserver_1_1handlers_1_1HttpHandlerBase.html" title="Base class for all the Userver HTTP Handlers.">server::handlers::HttpHandlerBase</a> {</div>
<div class="line"> <span class="keyword">public</span>:</div>
<div class="line">  <span class="keyword">static</span> constexpr std::string_view kName = <span class="stringliteral">&quot;handler-key-value&quot;</span>;</div>
<div class="line"> </div>
<div class="line">  KeyValue(<span class="keyword">const</span> <a class="code" href="../../db/dff/classcomponents_1_1ComponentConfig.html">components::ComponentConfig</a>&amp; config,</div>
<div class="line">           <span class="keyword">const</span> <a class="code" href="../../da/db1/classcomponents_1_1ComponentContext.html" title="Class to retrieve other components.">components::ComponentContext</a>&amp; context);</div>
<div class="line"> </div>
<div class="line">  std::string HandleRequestThrow(</div>
<div class="line">      <span class="keyword">const</span> <a class="code" href="../../d3/d44/classserver_1_1http_1_1HttpRequest.html" title="HTTP Request data.">server::http::HttpRequest</a>&amp; request,</div>
<div class="line">      <a class="code" href="../../de/df6/classserver_1_1request_1_1RequestContext.html" title="Stores request-specific data during request processing.">server::request::RequestContext</a>&amp;) <span class="keyword">const override</span>;</div>
<div class="line"> </div>
<div class="line"> <span class="keyword">private</span>:</div>
<div class="line">  std::string GetValue(std::string_view key,</div>
<div class="line">                       <span class="keyword">const</span> <a class="code" href="../../d3/d44/classserver_1_1http_1_1HttpRequest.html" title="HTTP Request data.">server::http::HttpRequest</a>&amp; request) <span class="keyword">const</span>;</div>
<div class="line">  std::string PostValue(std::string_view key,</div>
<div class="line">                        <span class="keyword">const</span> <a class="code" href="../../d3/d44/classserver_1_1http_1_1HttpRequest.html" title="HTTP Request data.">server::http::HttpRequest</a>&amp; request) <span class="keyword">const</span>;</div>
<div class="line">  std::string DeleteValue(std::string_view key) <span class="keyword">const</span>;</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="../../de/d6d/namespacestorages_1_1postgres.html#a1f3c170f905023f7794d9be83255de95" title="Smart pointer to the storages::postgres::Cluster.">storages::postgres::ClusterPtr</a> pg_cluster_;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line">}  <span class="comment">// namespace samples::pg</span></div>
</div><!-- fragment --><p> Note that the component holds a <a class="el" href="../../de/d6d/namespacestorages_1_1postgres.html#a1f3c170f905023f7794d9be83255de95" title="Smart pointer to the storages::postgres::Cluster.">storages::postgres::ClusterPtr</a> - a client to the PostgreSQL DB. That client is thread safe, you can use it concurrently from different threads and tasks.</p>
<h2><a class="anchor" id="autotoc_md315"></a>
Initializing the database</h2>
<p>To access the database from our new component we need to find the PostgreSQL component and request a client to the DB. After that we may create the required tables.</p>
<div class="fragment"><div class="line">KeyValue::KeyValue(<span class="keyword">const</span> <a class="code" href="../../db/dff/classcomponents_1_1ComponentConfig.html">components::ComponentConfig</a>&amp; config,</div>
<div class="line">                   <span class="keyword">const</span> <a class="code" href="../../da/db1/classcomponents_1_1ComponentContext.html" title="Class to retrieve other components.">components::ComponentContext</a>&amp; context)</div>
<div class="line">    : HttpHandlerBase(config, context),</div>
<div class="line">      pg_cluster_(</div>
<div class="line">          context.FindComponent&lt;<a class="code" href="../../d0/d1f/namespacecomponents.html" title="Contains functions and types to start a userver based service/tool.">components</a>::Postgres&gt;(<span class="stringliteral">&quot;key-value-database&quot;</span>)</div>
<div class="line">              .GetCluster()) {</div>
<div class="line">  constexpr <span class="keyword">auto</span> kCreateTable = R<span class="stringliteral">&quot;~(</span></div>
<div class="line"><span class="stringliteral">      CREATE TABLE IF NOT EXISTS key_value_table (</span></div>
<div class="line"><span class="stringliteral">        key VARCHAR PRIMARY KEY,</span></div>
<div class="line"><span class="stringliteral">        value VARCHAR</span></div>
<div class="line"><span class="stringliteral">      )</span></div>
<div class="line"><span class="stringliteral">    )~&quot;;</span></div>
<div class="line"><span class="stringliteral"></span> </div>
<div class="line"><span class="stringliteral">  </span><span class="keyword">using</span> <a class="code" href="../../de/d6d/namespacestorages_1_1postgres.html#a112991762e57633e6213c2cbbce7d62f">storages::postgres::ClusterHostType</a>;</div>
<div class="line">  pg_cluster_-&gt;Execute(ClusterHostType::kMaster, kCreateTable);</div>
<div class="line">}</div>
</div><!-- fragment --><p> To create a table we just execute an SQL statement, mentioning that it should go to the master instance. After that, our component is ready to process incoming requests in the KeyValue::HandleRequestThrow function.</p>
<h2><a class="anchor" id="autotoc_md316"></a>
KeyValue::HandleRequestThrow</h2>
<p>In this sample we use a single handler to deal with all the HTTP methods. The KeyValue::HandleRequestThrow member function mostly dispatches the request to one of the member functions that actually implement the key-value storage logic:</p>
<div class="fragment"><div class="line">std::string KeyValue::HandleRequestThrow(</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="../../d3/d44/classserver_1_1http_1_1HttpRequest.html" title="HTTP Request data.">server::http::HttpRequest</a>&amp; request,</div>
<div class="line">    <a class="code" href="../../de/df6/classserver_1_1request_1_1RequestContext.html" title="Stores request-specific data during request processing.">server::request::RequestContext</a>&amp;)<span class="keyword"> const </span>{</div>
<div class="line">  <span class="keyword">const</span> <span class="keyword">auto</span>&amp; key = request.<a class="code" href="../../d3/d44/classserver_1_1http_1_1HttpRequest.html#ad6c86e51f02572fb76ae9a8d58376884">GetArg</a>(<span class="stringliteral">&quot;key&quot;</span>);</div>
<div class="line">  <span class="keywordflow">if</span> (key.empty()) {</div>
<div class="line">    <span class="keywordflow">throw</span> <a class="code" href="../../db/d63/classserver_1_1handlers_1_1ClientError.html">server::handlers::ClientError</a>(</div>
<div class="line">        <a class="code" href="../../d7/da5/structserver_1_1handlers_1_1ExternalBody.html">server::handlers::ExternalBody</a>{<span class="stringliteral">&quot;No &#39;key&#39; query argument&quot;</span>});</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">switch</span> (request.GetMethod()) {</div>
<div class="line">    <span class="keywordflow">case</span> server::http::HttpMethod::kGet:</div>
<div class="line">      <span class="keywordflow">return</span> GetValue(key, request);</div>
<div class="line">    <span class="keywordflow">case</span> server::http::HttpMethod::kPost:</div>
<div class="line">      <span class="keywordflow">return</span> PostValue(key, request);</div>
<div class="line">    <span class="keywordflow">case</span> server::http::HttpMethod::kDelete:</div>
<div class="line">      <span class="keywordflow">return</span> DeleteValue(key);</div>
<div class="line">    <span class="keywordflow">default</span>:</div>
<div class="line">      <span class="keywordflow">throw</span> <a class="code" href="../../db/d63/classserver_1_1handlers_1_1ClientError.html">server::handlers::ClientError</a>(<a class="code" href="../../d7/da5/structserver_1_1handlers_1_1ExternalBody.html">server::handlers::ExternalBody</a>{</div>
<div class="line">          fmt::format(<span class="stringliteral">&quot;Unsupported method {}&quot;</span>, request.GetMethod())});</div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment --> <dl class="section warning"><dt>Warning</dt><dd><code>Handle*</code> functions are invoked concurrently on the same instance of the handler class. In this sample the KeyValue component only uses the thread safe DB client. In more complex cases <a class="el" href="../../d1/d6b/md_en_userver_synchronization.html">synchronization primitives</a> should be used or data must not be mutated.</dd></dl>
<h2><a class="anchor" id="autotoc_md317"></a>
KeyValue::GetValue</h2>
<p>Postgres driver in userver implicitly works with prepared statements. For the first time you execute the query a prepared statement is created. Executing the query next time would result in only sending the arguments for the already created prepared statement.</p>
<p>You could pass strings as queries, just like we done in constructor of KeyValue. Also queries could be stored in variables along with query names and reused across the functions. Name of the query could be used in dynamic configs to set the execution timeouts (see <a class="el" href="../../dd/d2c/md_en_schemas_dynamic_configs.html#POSTGRES_QUERIES_COMMAND_CONTROL">POSTGRES_QUERIES_COMMAND_CONTROL</a>).</p>
<div class="fragment"><div class="line"><span class="keyword">const</span> <a class="code" href="../../d2/d8f/classstorages_1_1postgres_1_1Query.html" title="Holds a query, its name and logging mode.">storages::postgres::Query</a> kSelectValue{</div>
<div class="line">    <span class="stringliteral">&quot;SELECT value FROM key_value_table WHERE key=$1&quot;</span>,</div>
<div class="line">    <a class="code" href="../../d4/d67/classutils_1_1StrongTypedef.html" title="Strong typedef for a type T.">storages::postgres::Query::Name</a>{<span class="stringliteral">&quot;sample_select_value&quot;</span>},</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line">std::string KeyValue::GetValue(std::string_view key,</div>
<div class="line">                               <span class="keyword">const</span> <a class="code" href="../../d3/d44/classserver_1_1http_1_1HttpRequest.html" title="HTTP Request data.">server::http::HttpRequest</a>&amp; request)<span class="keyword"> const </span>{</div>
<div class="line">  <a class="code" href="../../d0/d5b/classstorages_1_1postgres_1_1ResultSet.html" title="PostgreSQL result set.">storages::postgres::ResultSet</a> res = pg_cluster_-&gt;Execute(</div>
<div class="line">      <a class="code" href="../../de/d6d/namespacestorages_1_1postgres.html#a112991762e57633e6213c2cbbce7d62fa711876d1003646469de6eb5a7811927b">storages::postgres::ClusterHostType::kSlave</a>, kSelectValue, key);</div>
<div class="line">  <span class="keywordflow">if</span> (res.IsEmpty()) {</div>
<div class="line">    request.<a class="code" href="../../d3/d44/classserver_1_1http_1_1HttpRequest.html#a3e4903d158a34e717668af618e56af92" title="Set the response status code.">SetResponseStatus</a>(server::http::HttpStatus::kNotFound);</div>
<div class="line">    <span class="keywordflow">return</span> {};</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> res.<a class="code" href="../../d0/d5b/classstorages_1_1postgres_1_1ResultSet.html#af396fa72f7e8dae52bc627d3955295c4" title="Extract first row into user type. A single row result set is expected, will throw an exception when r...">AsSingleRow</a>&lt;std::string&gt;();</div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md318"></a>
KeyValue::PostValue</h2>
<p>You can start a transaction by calling <a class="el" href="../../dd/d69/classstorages_1_1postgres_1_1Cluster.html#a03bd02e2c9d945b75d12745465c9a871">storages::postgres::Cluster::Begin()</a>. Transactions are automatically rolled back, if you do not commit them. To execute a query in transaction, just call Execute member function of a transaction. Just like with non-transactional Execute, you can pass string or <a class="el" href="../../d2/d8f/classstorages_1_1postgres_1_1Query.html" title="Holds a query, its name and logging mode.">storages::postgres::Query</a>, you could reuse the same query in different functions. Transactions also could be named, and those names could be used in <a class="el" href="../../dd/d2c/md_en_schemas_dynamic_configs.html#POSTGRES_QUERIES_COMMAND_CONTROL">POSTGRES_QUERIES_COMMAND_CONTROL</a>.</p>
<div class="fragment"><div class="line"><span class="keyword">const</span> <a class="code" href="../../d2/d8f/classstorages_1_1postgres_1_1Query.html" title="Holds a query, its name and logging mode.">storages::postgres::Query</a> kInsertValue{</div>
<div class="line">    <span class="stringliteral">&quot;INSERT INTO key_value_table (key, value) &quot;</span></div>
<div class="line">    <span class="stringliteral">&quot;VALUES ($1, $2) &quot;</span></div>
<div class="line">    <span class="stringliteral">&quot;ON CONFLICT DO NOTHING&quot;</span>,</div>
<div class="line">    <a class="code" href="../../d4/d67/classutils_1_1StrongTypedef.html" title="Strong typedef for a type T.">storages::postgres::Query::Name</a>{<span class="stringliteral">&quot;sample_insert_value&quot;</span>},</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line">std::string KeyValue::PostValue(</div>
<div class="line">    std::string_view key, <span class="keyword">const</span> <a class="code" href="../../d3/d44/classserver_1_1http_1_1HttpRequest.html" title="HTTP Request data.">server::http::HttpRequest</a>&amp; request)<span class="keyword"> const </span>{</div>
<div class="line">  <span class="keyword">const</span> <span class="keyword">auto</span>&amp; value = request.<a class="code" href="../../d3/d44/classserver_1_1http_1_1HttpRequest.html#ad6c86e51f02572fb76ae9a8d58376884">GetArg</a>(<span class="stringliteral">&quot;value&quot;</span>);</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="../../d1/dc2/classstorages_1_1postgres_1_1Transaction.html" title="PostgreSQL transaction.">storages::postgres::Transaction</a> transaction =</div>
<div class="line">      pg_cluster_-&gt;Begin(<span class="stringliteral">&quot;sample_transaction_insert_key_value&quot;</span>,</div>
<div class="line">                         <a class="code" href="../../de/d6d/namespacestorages_1_1postgres.html#a112991762e57633e6213c2cbbce7d62fad4720c3695455d7cf5bce1b2c7bcecdf">storages::postgres::ClusterHostType::kMaster</a>, {});</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">auto</span> res = transaction.Execute(kInsertValue, key, value);</div>
<div class="line">  <span class="keywordflow">if</span> (res.RowsAffected()) {</div>
<div class="line">    transaction.<a class="code" href="../../d1/dc2/classstorages_1_1postgres_1_1Transaction.html#a78f89d3766bfff77e3390db9cddc6d66">Commit</a>();</div>
<div class="line">    request.<a class="code" href="../../d3/d44/classserver_1_1http_1_1HttpRequest.html#a3e4903d158a34e717668af618e56af92" title="Set the response status code.">SetResponseStatus</a>(server::http::HttpStatus::kCreated);</div>
<div class="line">    <span class="keywordflow">return</span> std::string{value};</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  res = transaction.Execute(kSelectValue, key);</div>
<div class="line">  transaction.<a class="code" href="../../d1/dc2/classstorages_1_1postgres_1_1Transaction.html#a221a27c28748ec5236d2113355486a1c">Rollback</a>();</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">auto</span> result = res.<a class="code" href="../../d0/d5b/classstorages_1_1postgres_1_1ResultSet.html#af396fa72f7e8dae52bc627d3955295c4" title="Extract first row into user type. A single row result set is expected, will throw an exception when r...">AsSingleRow</a>&lt;std::string&gt;();</div>
<div class="line">  <span class="keywordflow">if</span> (result != value) {</div>
<div class="line">    request.<a class="code" href="../../d3/d44/classserver_1_1http_1_1HttpRequest.html#a3e4903d158a34e717668af618e56af92" title="Set the response status code.">SetResponseStatus</a>(server::http::HttpStatus::kConflict);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> res.<a class="code" href="../../d0/d5b/classstorages_1_1postgres_1_1ResultSet.html#af396fa72f7e8dae52bc627d3955295c4" title="Extract first row into user type. A single row result set is expected, will throw an exception when r...">AsSingleRow</a>&lt;std::string&gt;();</div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md319"></a>
KeyValue::DeleteValue</h2>
<p>Note that mutating queries should be executed on a master instance.</p>
<div class="fragment"><div class="line">std::string KeyValue::DeleteValue(std::string_view key)<span class="keyword"> const </span>{</div>
<div class="line">  <span class="keyword">auto</span> res =</div>
<div class="line">      pg_cluster_-&gt;Execute(<a class="code" href="../../de/d6d/namespacestorages_1_1postgres.html#a112991762e57633e6213c2cbbce7d62fad4720c3695455d7cf5bce1b2c7bcecdf">storages::postgres::ClusterHostType::kMaster</a>,</div>
<div class="line">                           <span class="stringliteral">&quot;DELETE FROM key_value_table WHERE key=$1&quot;</span>, key);</div>
<div class="line">  <span class="keywordflow">return</span> std::to_string(res.RowsAffected());</div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md320"></a>
Static config</h2>
<p>Static configuration of service is quite close to the configuration from <a class="el" href="../../d9/d72/md_en_userver_tutorial_hello_service.html">Writing your first HTTP server</a> except for the handler and DB:</p>
<div class="fragment"><div class="line"># yaml</div>
<div class="line">components_manager:</div>
<div class="line">    components:                       # Configuring components that were registered via component_list</div>
<div class="line">        handler-key-value:</div>
<div class="line">            path: /v1/key-value                  # Registering handler by URL &#39;/v1/key-value&#39;.</div>
<div class="line">            task_processor: main-task-processor  # Run it on CPU bound task processor</div>
<div class="line">            method: GET,DELETE,POST</div>
<div class="line"> </div>
<div class="line">        key-value-database:</div>
<div class="line">            dbconnection: &#39;postgresql://testsuite@localhost:15433/postgres&#39;</div>
<div class="line">            blocking_task_processor: fs-task-processor</div>
<div class="line">            dns_resolver: async</div>
<div class="line"> </div>
<div class="line">        testsuite-support:</div>
<div class="line"> </div>
<div class="line">        server:</div>
<div class="line">            # ...</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md321"></a>
Dynamic config</h2>
<p>We are not planning to get new dynamic config values in this sample. Because of that we just write the defaults to the fallback file of the <code><a class="el" href="../../d8/d9c/classcomponents_1_1DynamicConfigFallbacks.html" title="Component that setup runtime configs based on fallbacks from file.">components::DynamicConfigFallbacks</a></code> component: <a class="el" href="../../d8/d86/samples_2postgres_service_2dynamic_config_fallback_8json-example.html">samples/postgres_service/dynamic_config_fallback.json</a></p>
<p>All the values are described in a separate section <a class="el" href="../../dd/d2c/md_en_schemas_dynamic_configs.html">Dynamic configs</a> .</p>
<p>A production ready service would dynamically retrieve the above options at runtime from a configuration service. See <a class="el" href="../../dd/d69/md_en_userver_tutorial_config_service.html">Writing your own configs server</a> for insights on how to change the above options on the fly, without restarting the service.</p>
<h2><a class="anchor" id="autotoc_md322"></a>
int main()</h2>
<p>Finally, after writing down the dynamic config values into file at <code>taxi-config-fallbacks.fallback-path</code>, we add our component to the <a class="el" href="../../dd/d1c/group__userver__components.html#ga44510c5120b67bd36f0ff9f845c68280" title="Returns a list of components to start a basic HTTP server.">components::MinimalServerComponentList()</a>, and start the server with static config <code>kStaticConfig</code>.</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span>* argv[]) {</div>
<div class="line">  <span class="keyword">const</span> <span class="keyword">auto</span> component_list =</div>
<div class="line">      <a class="code" href="../../dd/d1c/group__userver__components.html#ga44510c5120b67bd36f0ff9f845c68280" title="Returns a list of components to start a basic HTTP server.">components::MinimalServerComponentList</a>()</div>
<div class="line">          .Append&lt;samples::pg::KeyValue&gt;()</div>
<div class="line">          .Append&lt;components::Postgres&gt;(<span class="stringliteral">&quot;key-value-database&quot;</span>)</div>
<div class="line">          .Append&lt;<a class="code" href="../../d9/de2/classcomponents_1_1TestsuiteSupport.html" title="Testsuite support component.">components::TestsuiteSupport</a>&gt;()</div>
<div class="line">          .Append&lt;clients::dns::Component&gt;();</div>
<div class="line">  <span class="keywordflow">return</span> <a class="code" href="../../d6/d84/namespaceutils.html#a40294f3ed93c7f13cb2c814d70134820">utils::DaemonMain</a>(argc, argv, component_list);</div>
<div class="line">}</div>
</div><!-- fragment --> <h2><a class="anchor" id="autotoc_md323"></a>
Build</h2>
<p>To build the sample, execute the following build steps at the userver root directory: </p><div class="fragment"><div class="line">mkdir build_release</div>
<div class="line">cd build_release</div>
<div class="line">cmake -DCMAKE_BUILD_TYPE=Release ..</div>
<div class="line">make userver-samples-postgres_service</div>
</div><!-- fragment --><p>Start the DB server and then start the service by running <code>./samples/postgres_service/userver-samples-postgres_service</code>. Now you can send a request to your service from another terminal: </p><div class="fragment"><div class="line">bash</div>
<div class="line">$ curl -X POST &#39;localhost:8085/v1/key-value?key=hello&amp;value=world&#39; -i</div>
<div class="line">HTTP/1.1 201 Created</div>
<div class="line">Date: Wed, 27 Oct 2021 16:45:13 UTC</div>
<div class="line">Content-Type: text/html</div>
<div class="line">X-YaSpanId: 015fb0becd2926ef</div>
<div class="line">X-YaRequestId: 7830671d7dd2462ba9043db532c2b82a</div>
<div class="line">Server: userver/1.0.0 (20211027123413; rv:c1879aa03)</div>
<div class="line">X-YaTraceId: d7422d7bcdc9493997fc687f8be24883</div>
<div class="line">Connection: keep-alive</div>
<div class="line">Content-Length: 5</div>
<div class="line"> </div>
<div class="line">world</div>
<div class="line">$ curl -X POST &#39;localhost:8085/v1/key-value?key=hello&amp;value=nope&#39; -i</div>
<div class="line">HTTP/1.1 409 Conflict</div>
<div class="line">Date: Wed, 27 Oct 2021 16:45:56 UTC</div>
<div class="line">Content-Type: text/html</div>
<div class="line">X-YaSpanId: e1e2702b87ceeede</div>
<div class="line">X-YaRequestId: 4f677a7cd405418ea412fd4ec540676a</div>
<div class="line">Server: userver/1.0.0 (20211027123413; rv:c1879aa03)</div>
<div class="line">X-YaTraceId: 203870322f704b308c4322bd44b354ed</div>
<div class="line">Connection: keep-alive</div>
<div class="line">Content-Length: 5</div>
<div class="line"> </div>
<div class="line">world</div>
<div class="line">$ curl -X DELETE &#39;localhost:8085/v1/key-value?key=hello&amp;value=world&#39; -i</div>
<div class="line">HTTP/1.1 200 OK</div>
<div class="line">Date: Wed, 27 Oct 2021 16:46:35 UTC</div>
<div class="line">Content-Type: text/html</div>
<div class="line">X-YaSpanId: e83698e2ef8cc729</div>
<div class="line">X-YaRequestId: ffbaacae38e64bb588affa10b928b759</div>
<div class="line">Server: userver/1.0.0 (20211027123413; rv:c1879aa03)</div>
<div class="line">X-YaTraceId: cd3e6acc299742739bb22c795b6ef3a7</div>
<div class="line">Connection: keep-alive</div>
<div class="line">Content-Length: 1</div>
<div class="line"> </div>
<div class="line">1</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md324"></a>
Functional testing</h2>
<p><a class="el" href="../../d1/dd6/md_en_userver_functional_testing.html">Functional tests</a> for the service could be implemented using the testsuite. To do that you have to:</p>
<ul>
<li>Provide PostgreSQL schema to start the database: <div class="fragment"><div class="line"><span class="keyword">from</span> testsuite.databases.pgsql <span class="keyword">import</span> discover</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">@pytest.fixture(scope=<span class="stringliteral">&#39;session&#39;</span>)</div>
<div class="line"><span class="keyword">def </span>pgsql_local(service_source_dir, pgsql_local_create):</div>
<div class="line">    databases = discover.find_schemas(</div>
<div class="line">        <span class="stringliteral">&#39;admin&#39;</span>, [service_source_dir.joinpath(<span class="stringliteral">&#39;schemas/postgresql&#39;</span>)],</div>
<div class="line">    )</div>
<div class="line">    <span class="keywordflow">return</span> pgsql_local_create(list(databases.values()))</div>
</div><!-- fragment --></li>
<li>Tell the testsuite to start the PostgreSQL database: <div class="fragment"><div class="line">@pytest.fixture</div>
<div class="line"><span class="keyword">def </span>client_deps(pgsql):</div>
<div class="line">    <span class="keywordflow">pass</span></div>
</div><!-- fragment --></li>
<li>Write the test: <div class="fragment"><div class="line">async <span class="keyword">def </span>test_postgres(service_client):</div>
<div class="line">    response = await service_client.delete(<span class="stringliteral">&#39;/v1/key-value?key=hello&#39;</span>)</div>
<div class="line">    <span class="keyword">assert</span> response.status == 200</div>
<div class="line"> </div>
<div class="line">    response = await service_client.post(<span class="stringliteral">&#39;/v1/key-value?key=hello&amp;value=world&#39;</span>)</div>
<div class="line">    <span class="keyword">assert</span> response.status == 201</div>
<div class="line">    <span class="keyword">assert</span> response.content == b<span class="stringliteral">&#39;world&#39;</span></div>
<div class="line"> </div>
<div class="line">    response = await service_client.get(<span class="stringliteral">&#39;/v1/key-value?key=hello&#39;</span>)</div>
<div class="line">    <span class="keyword">assert</span> response.status == 200</div>
<div class="line">    <span class="keyword">assert</span> response.content == b<span class="stringliteral">&#39;world&#39;</span></div>
<div class="line"> </div>
<div class="line">    response = await service_client.delete(<span class="stringliteral">&#39;/v1/key-value?key=hello&#39;</span>)</div>
<div class="line">    <span class="keyword">assert</span> response.status == 200</div>
<div class="line"> </div>
<div class="line">    response = await service_client.post(<span class="stringliteral">&#39;/v1/key-value?key=hello&amp;value=there&#39;</span>)</div>
<div class="line">    <span class="keyword">assert</span> response.status == 201</div>
<div class="line">    <span class="keyword">assert</span> response.content == b<span class="stringliteral">&#39;there&#39;</span></div>
</div><!-- fragment --></li>
</ul>
<h1><a class="anchor" id="autotoc_md325"></a>
Full sources</h1>
<p>See the full example:</p><ul>
<li><a class="el" href="../../dd/dd2/samples_2postgres_service_2postgres_service_8cpp-example.html">samples/postgres_service/postgres_service.cpp</a></li>
<li><a class="el" href="../../da/daa/samples_2postgres_service_2static_config_8yaml-example.html">samples/postgres_service/static_config.yaml</a></li>
<li><a class="el" href="../../d8/d86/samples_2postgres_service_2dynamic_config_fallback_8json-example.html">samples/postgres_service/dynamic_config_fallback.json</a></li>
<li><a class="el" href="../../d5/dbe/samples_2postgres_service_2CMakeLists_8txt-example.html">samples/postgres_service/CMakeLists.txt</a></li>
<li><a class="el" href="../../d2/d55/samples_2postgres_service_2tests_2conftest_8py-example.html">samples/postgres_service/tests/conftest.py</a></li>
<li><a class="el" href="../../d4/d59/samples_2postgres_service_2tests_2test_postgres_8py-example.html">samples/postgres_service/tests/test_postgres.py</a> </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- HTML footer for doxygen 1.8.13-->
<!-- start footer part -->
<hr class="footer"/>
<a id='page_edit' style="float:left; padding-left: 7pt;" href="#">⚒ Редактировать страницу</a>
<address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="../../doxygen.png" alt="doxygen"/>
</a> 1.8.17
</small></address>
<script type="text/javascript">
const LOWER_CASE_TRANSLITTERATION_MAPPING = {
    "а":"a", "б":"b", "в":"v", "г":"g", "д":"d", "е":"e", "ё":"jo", "ж":"zh",
    "з":"z", "и":"i", "й":"jj", "к":"k", "л":"l", "м":"m", "н":"n", "о":"o",
    "п":"p", "р":"r", "с":"s", "т":"t", "у":"u", "ф":"f", "х":"x", "ц":"c",
    "ч":"ch", "ш":"sh", "щ":"shh", "ъ":"\'", "ы":"y", "ь":"\'", "э":"je",
    "ю":"ju", "я":"ja"
};
const DOXYGEN_DIAMOND_STRING = '◆\u00A0' // ◆&nbsp;
function make_id(raw_id) {
    return raw_id.toLowerCase().split('').map(function (char) {
        return LOWER_CASE_TRANSLITTERATION_MAPPING[char] || char;
    }).join('').replace(/\W/g, '');
}
const html_escape = function () {
    const p = document.createElement('p');
    return function (text) {
        p.textContent = text;
        return p.innerHTML;
    };
}();
function setup_page_edit() {
    let href = window.location.href;
    const idx = href.indexOf('md_ru_');
    if (idx === -1) {
        $('#page_edit').hide();
        return;
    }
    href = href.substring(idx).split('.html')[0];
    href = href.split('#')[0];
    href = href.replace('md_ru_', 'https://wiki.yandex-team.ru/taxi/backend/');
    href = href.replaceAll('_', '/');
    $('#page_edit').attr("href", href + '/.edit');
}
function draw_toc() {
    let headers = $(':header');
    if (headers.length === 0) {
        return;
    }
    let sidenav_content = '<div id="mySidenav" class="sidenav">';
    sidenav_content += '<h2>Table of contents</h2>';
    headers.each(function() {
        let index = parseInt(this.nodeName.substring(1)) - 1;
        const header = $(this);
        let id = header.attr('id');
        if (!id) {
          id = make_id(header.text())
          header.attr('id', id);
        }
        let header_text = header.text()
        if (header_text.startsWith(DOXYGEN_DIAMOND_STRING)) {
            ++index;
            header_text = header_text.substring(DOXYGEN_DIAMOND_STRING.length);
        }
        sidenav_content += ''
          + '<a href="#' + id + '" style="padding-left: ' + index * 15 + 'px">'
          + '•&nbsp;' + html_escape(header_text)
          + '</a>'
        ;
        header.append(' <a class="hoverlink" href="#' + id + '">🔗</a>')
    });
    sidenav_content += '</div>';
    $(sidenav_content).insertAfter('.header');
}
function highlight_code() {
    if (window.location.href.indexOf("pp_source") !== -1
        || window.location.href.indexOf("cpp-example") !== -1) {
        // Header listing is already nicely highlighted by Doxygen
        return;
    }
    hljs.configure({
        tabReplace: '    ' // 4 spaces
    });
    hljs.registerAliases('py', {languageName: 'python'});
    hljs.registerAliases('sh', {languageName: 'shell'});
    hljs.registerAliases('bash', {languageName: 'shell'});
    hljs.registerAliases('yml', {languageName: 'yaml'});
    hljs.registerAliases('plain', {languageName: 'plaintext'});
    hljs.registerAliases('tskv', {languageName: 'plaintext'});
    $(".fragment").each(function() {
        const node = $(this);
        let data = '';
        let language = '';
        let requires_higlighting = true;
        node.children('div.line').each(function(i) {
            line = $(this).text();
            // Doxygen 1.8.11 workaround to remove line numbers.
            // No line numbers added in Doxygen 1.8.13
            line = line.replace(/^ *\d+\xA0/, '');
            if (i === 0) {
                line = line.trimLeft().replace(/^# /, '');
                if (line === 'autodetect') {
                    return true;
                } else if (hljs.getLanguage(line)) {
                    language = line;
                    return true;
                } else {
                    requires_higlighting = false;
                    return false;
                }
            }
            data += line + '\n';
        });
        if (requires_higlighting === false) {
            return;
        }
        if (language !== '') {
            data = hljs.highlight(language, data).value;
        } else {
            data = hljs.highlightAuto(data).value;
        }
        node.replaceWith('<div class="fragment"><pre>' + data + '</pre></div>');
    });
}
function setup_if_landing() {
    if (document.getElementById('landing_logo_id') === null) {
        return false;
    }
    $('#titlearea').hide();
    const main_nav = $('#main-nav')
    main_nav.addClass('main-nav-landing');
    main_nav.append('<hr>');
    $('.header').hide();
    $('body').css('background-color', 'black');
    $('#page_edit').hide();
    return true;
}
function sticky_menu() {
    const main_nav = $('#main-nav');
    const menu_y_position = 94;
    const search_results_window = $('#MSearchResultsWindow');
    var menu_is_sticky = false;
    const stick = function () {
        if ($(this).scrollTop() > menu_y_position) {
            if (menu_is_sticky) return;
            search_results_window.addClass('stickySearchResults');
            main_nav.addClass('stickyHeader');
            menu_is_sticky = true;
        } else {
            if (!menu_is_sticky) return;
            search_results_window.removeClass('stickySearchResults');
            // 'top' property of the results window is computed by Doxygen JS
            // and it may give bad results if the computation is invoked at the
            // middle of the page.
            //
            // Hiding the window. Doxygen will recompute and show it on new
            // user input.
            search_results_window.hide();
            main_nav.removeClass('stickyHeader');
            menu_is_sticky = false;
        }
    };
    stick();  // on page refresh draw the menu on a right position
    $(window).on("scroll", stick);
}
function telegram_channel_language() {
  if (/^ru/.test(navigator.language)) {
    const channel = $('#telegram_channel');
    if (channel) {
      channel.attr('href', 'https://t.me/+AdadhDPVG5xhNWRi');
    }
  }
}
$(function() {
    if (setup_if_landing()) return;
    draw_toc();
    highlight_code();
    setup_page_edit();
    telegram_channel_language();
    sticky_menu();
});
</script>
</body>
</html>
