<!-- HTML header for doxygen 1.8.13-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<link rel="icon" href="../../favicon.svg">
<title>userver: storages::mongo::DistLockComponentBase Class Reference</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<link rel="stylesheet" href="../../doxygen-like.css">
<script src="../../highlight.pack.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../customdoxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0" style="width: 100%;">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><a id='logo-anchor' href="../../index.html"><img alt="Logo" src="../../logo.svg"/></a></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname"><a class="titlelink" href="../../index.html">userver
   </a>
   </div>
   <div id="projectbrief"><a class="titlelink" href="../../index.html">C++ Async Framework (beta)</a></div>
  </td>
  <td style="float: right; padding-right: 40px; padding-top: 15px;">
    <a href="https://github.com/userver-framework/userver" rel="noopener" target="_blank" class="titlelink">
      <img src="../../github_logo.svg" alt="Github"/>
    </a>
    &nbsp;
    <a href="https://t.me/+i3k5A6V0oFgwNmYy" rel="noopener" id='telegram_channel' target="_blank" class="titlelink">
      <img src="../../telegram_logo.svg" alt="Telegram"/>
    </a>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="../../d0/d91/namespacestorages.html">storages</a></li><li class="navelem"><a class="el" href="../../d3/db5/namespacestorages_1_1mongo.html">mongo</a></li><li class="navelem"><a class="el" href="../../db/df7/classstorages_1_1mongo_1_1DistLockComponentBase.html">DistLockComponentBase</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#pub-methods">Public Member Functions</a> &#124;
<a href="#pub-static-methods">Static Public Member Functions</a> &#124;
<a href="#pro-methods">Protected Member Functions</a> &#124;
<a href="../../d6/d37/classstorages_1_1mongo_1_1DistLockComponentBase-members.html">List of all members</a>  </div>
  <div class="headertitle">
<div class="title">storages::mongo::DistLockComponentBase Class Reference<span class="mlabels"><span class="mlabel">abstract</span></span><div class="ingroups"><a class="el" href="../../dd/d1c/group__userver__components.html">Components</a> &#124; <a class="el" href="../../da/d0c/group__userver__base__classes.html">Base Classes</a></div></div>  </div>
</div><!--header-->
<div class="contents">

<p>Base class for mongo-based distlock worker components.  
 <a href="../../db/df7/classstorages_1_1mongo_1_1DistLockComponentBase.html#details">More...</a></p>

<p><code>#include &lt;<a class="el" href="../../d5/d93/mongo_2include_2userver_2storages_2mongo_2dist__lock__component__base_8hpp_source.html">userver/storages/mongo/dist_lock_component_base.hpp</a>&gt;</code></p>
<div id="dynsection-0" onclick="return toggleVisibility(this)" class="dynheader closed" style="cursor:pointer;">
  <img id="dynsection-0-trigger" src="../../closed.png" alt="+"/> Inheritance diagram for storages::mongo::DistLockComponentBase:</div>
<div id="dynsection-0-summary" class="dynsummary" style="display:block;">
</div>
<div id="dynsection-0-content" class="dyncontent" style="display:none;">
<div class="center"><img src="../../df/d19/classstorages_1_1mongo_1_1DistLockComponentBase__inherit__graph.png" border="0" usemap="#storages_1_1mongo_1_1DistLockComponentBase_inherit__map" alt="Inheritance graph"/></div>
<map name="storages_1_1mongo_1_1DistLockComponentBase_inherit__map" id="storages_1_1mongo_1_1DistLockComponentBase_inherit__map">
<area shape="rect" title="Base class for mongo&#45;based distlock worker components." alt="" coords="46,155,241,196"/>
<area shape="rect" href="../../d5/d69/classcomponents_1_1LoggableComponentBase.html" title="Base class for all application components, it depends on components::Logger and components::Tracer." alt="" coords="5,80,281,107"/>
<area shape="rect" title="Don&#39;t use it for application components, use LoggableComponentBase instead." alt="" coords="16,5,271,32"/>
</map>
<center><span class="legend">[<a href="../../graph_legend.html">legend</a>]</span></center></div>
<div id="dynsection-1" onclick="return toggleVisibility(this)" class="dynheader closed" style="cursor:pointer;">
  <img id="dynsection-1-trigger" src="../../closed.png" alt="+"/> Collaboration diagram for storages::mongo::DistLockComponentBase:</div>
<div id="dynsection-1-summary" class="dynsummary" style="display:block;">
</div>
<div id="dynsection-1-content" class="dyncontent" style="display:none;">
<div class="center"><img src="../../dd/d8e/classstorages_1_1mongo_1_1DistLockComponentBase__coll__graph.png" border="0" usemap="#storages_1_1mongo_1_1DistLockComponentBase_coll__map" alt="Collaboration graph"/></div>
<map name="storages_1_1mongo_1_1DistLockComponentBase_coll__map" id="storages_1_1mongo_1_1DistLockComponentBase_coll__map">
<area shape="rect" title="Base class for mongo&#45;based distlock worker components." alt="" coords="46,155,241,196"/>
<area shape="rect" href="../../d5/d69/classcomponents_1_1LoggableComponentBase.html" title="Base class for all application components, it depends on components::Logger and components::Tracer." alt="" coords="5,80,281,107"/>
<area shape="rect" title="Don&#39;t use it for application components, use LoggableComponentBase instead." alt="" coords="16,5,271,32"/>
</map>
<center><span class="legend">[<a href="../../graph_legend.html">legend</a>]</span></center></div>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="pub-methods"></a>
Public Member Functions</h2></td></tr>
<tr class="memitem:a4d8f16d603b76f341c139912ffe78f88"><td class="memItemLeft" align="right" valign="top"><a id="a4d8f16d603b76f341c139912ffe78f88"></a>
&#160;</td><td class="memItemRight" valign="bottom"><b>DistLockComponentBase</b> (const <a class="el" href="../../db/dff/classcomponents_1_1ComponentConfig.html">components::ComponentConfig</a> &amp;, const <a class="el" href="../../da/db1/classcomponents_1_1ComponentContext.html">components::ComponentContext</a> &amp;, <a class="el" href="../../db/d50/classstorages_1_1mongo_1_1Collection.html">storages::mongo::Collection</a>)</td></tr>
<tr class="separator:a4d8f16d603b76f341c139912ffe78f88"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aa73f39f3dbcee7d86fdcfa179fa22edf"><td class="memItemLeft" align="right" valign="top"><a id="aa73f39f3dbcee7d86fdcfa179fa22edf"></a>
<a class="el" href="../../d4/d24/classdist__lock_1_1DistLockedWorker.html">dist_lock::DistLockedWorker</a> &amp;&#160;</td><td class="memItemRight" valign="bottom"><b>GetWorker</b> ()</td></tr>
<tr class="separator:aa73f39f3dbcee7d86fdcfa179fa22edf"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="inherit_header pub_methods_classcomponents_1_1LoggableComponentBase"><td colspan="2" onclick="javascript:toggleInherit('pub_methods_classcomponents_1_1LoggableComponentBase')"><img src="../../closed.png" alt="-"/>&#160;Public Member Functions inherited from <a class="el" href="../../d5/d69/classcomponents_1_1LoggableComponentBase.html">components::LoggableComponentBase</a></td></tr>
<tr class="memitem:a7b2b853a1b16547cc5e1b8c54f69c376 inherit pub_methods_classcomponents_1_1LoggableComponentBase"><td class="memItemLeft" align="right" valign="top"><a id="a7b2b853a1b16547cc5e1b8c54f69c376"></a>
&#160;</td><td class="memItemRight" valign="bottom"><b>LoggableComponentBase</b> (const <a class="el" href="../../db/dff/classcomponents_1_1ComponentConfig.html">ComponentConfig</a> &amp;, const <a class="el" href="../../da/db1/classcomponents_1_1ComponentContext.html">ComponentContext</a> &amp;)</td></tr>
<tr class="separator:a7b2b853a1b16547cc5e1b8c54f69c376 inherit pub_methods_classcomponents_1_1LoggableComponentBase"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:af8840d7199368a6425d4c4fc87ffe2e9 inherit pub_methods_classcomponents_1_1LoggableComponentBase"><td class="memItemLeft" align="right" valign="top"><a id="af8840d7199368a6425d4c4fc87ffe2e9"></a>
&#160;</td><td class="memItemRight" valign="bottom"><b>LoggableComponentBase</b> (<a class="el" href="../../d5/d69/classcomponents_1_1LoggableComponentBase.html">LoggableComponentBase</a> &amp;&amp;)=delete</td></tr>
<tr class="separator:af8840d7199368a6425d4c4fc87ffe2e9 inherit pub_methods_classcomponents_1_1LoggableComponentBase"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a492b43c837c34c90e1ccc4fd8264878f inherit pub_methods_classcomponents_1_1LoggableComponentBase"><td class="memItemLeft" align="right" valign="top"><a id="a492b43c837c34c90e1ccc4fd8264878f"></a>
&#160;</td><td class="memItemRight" valign="bottom"><b>LoggableComponentBase</b> (const <a class="el" href="../../d5/d69/classcomponents_1_1LoggableComponentBase.html">LoggableComponentBase</a> &amp;)=delete</td></tr>
<tr class="separator:a492b43c837c34c90e1ccc4fd8264878f inherit pub_methods_classcomponents_1_1LoggableComponentBase"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a9408f7cb9eace1fe8b9b5ff68c901015 inherit pub_methods_classcomponents_1_1LoggableComponentBase"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d5/d69/classcomponents_1_1LoggableComponentBase.html#a9408f7cb9eace1fe8b9b5ff68c901015">~LoggableComponentBase</a> () override=default</td></tr>
<tr class="separator:a9408f7cb9eace1fe8b9b5ff68c901015 inherit pub_methods_classcomponents_1_1LoggableComponentBase"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aa5544da96b967a63593cf4900a290000 inherit pub_methods_classcomponents_1_1LoggableComponentBase"><td class="memItemLeft" align="right" valign="top"><a class="el" href="../../d0/d1f/namespacecomponents.html#a7a041524f23130330b0aec16f1e3410f">ComponentHealth</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d5/d69/classcomponents_1_1LoggableComponentBase.html#aa5544da96b967a63593cf4900a290000">GetComponentHealth</a> () const override</td></tr>
<tr class="separator:aa5544da96b967a63593cf4900a290000 inherit pub_methods_classcomponents_1_1LoggableComponentBase"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ad2c5e6609069a774fd8cbe2a622e34b3 inherit pub_methods_classcomponents_1_1LoggableComponentBase"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d5/d69/classcomponents_1_1LoggableComponentBase.html#ad2c5e6609069a774fd8cbe2a622e34b3">OnLoadingCancelled</a> () override</td></tr>
<tr class="separator:ad2c5e6609069a774fd8cbe2a622e34b3 inherit pub_methods_classcomponents_1_1LoggableComponentBase"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:acdcabdef99950f3c2abec1ff0069f573 inherit pub_methods_classcomponents_1_1LoggableComponentBase"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d5/d69/classcomponents_1_1LoggableComponentBase.html#acdcabdef99950f3c2abec1ff0069f573">OnAllComponentsLoaded</a> () override</td></tr>
<tr class="separator:acdcabdef99950f3c2abec1ff0069f573 inherit pub_methods_classcomponents_1_1LoggableComponentBase"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a5ff153ac78db3fbf3c3689e324e03ad5 inherit pub_methods_classcomponents_1_1LoggableComponentBase"><td class="memItemLeft" align="right" valign="top"><a id="a5ff153ac78db3fbf3c3689e324e03ad5"></a>
void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d5/d69/classcomponents_1_1LoggableComponentBase.html#a5ff153ac78db3fbf3c3689e324e03ad5">OnAllComponentsAreStopping</a> () override</td></tr>
<tr class="memdesc:a5ff153ac78db3fbf3c3689e324e03ad5 inherit pub_methods_classcomponents_1_1LoggableComponentBase"><td class="mdescLeft">&#160;</td><td class="mdescRight">Same as <a class="el" href="../../d5/d69/classcomponents_1_1LoggableComponentBase.html#acdcabdef99950f3c2abec1ff0069f573">OnAllComponentsLoaded()</a>. Just do not use it. <br /></td></tr>
<tr class="separator:a5ff153ac78db3fbf3c3689e324e03ad5 inherit pub_methods_classcomponents_1_1LoggableComponentBase"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="pub-static-methods"></a>
Static Public Member Functions</h2></td></tr>
<tr class="memitem:ad962425b810980f1a08b9015caedafdd"><td class="memItemLeft" align="right" valign="top"><a id="ad962425b810980f1a08b9015caedafdd"></a>
static <a class="el" href="../../d1/d3e/structyaml__config_1_1Schema.html">yaml_config::Schema</a>&#160;</td><td class="memItemRight" valign="bottom"><b>GetStaticConfigSchema</b> ()</td></tr>
<tr class="separator:ad962425b810980f1a08b9015caedafdd"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="inherit_header pub_static_methods_classcomponents_1_1LoggableComponentBase"><td colspan="2" onclick="javascript:toggleInherit('pub_static_methods_classcomponents_1_1LoggableComponentBase')"><img src="../../closed.png" alt="-"/>&#160;Static Public Member Functions inherited from <a class="el" href="../../d5/d69/classcomponents_1_1LoggableComponentBase.html">components::LoggableComponentBase</a></td></tr>
<tr class="memitem:a0444cf509b540497db68eb59782ac00c inherit pub_static_methods_classcomponents_1_1LoggableComponentBase"><td class="memItemLeft" align="right" valign="top"><a id="a0444cf509b540497db68eb59782ac00c"></a>
static <a class="el" href="../../d1/d3e/structyaml__config_1_1Schema.html">yaml_config::Schema</a>&#160;</td><td class="memItemRight" valign="bottom"><b>GetStaticConfigSchema</b> ()</td></tr>
<tr class="separator:a0444cf509b540497db68eb59782ac00c inherit pub_static_methods_classcomponents_1_1LoggableComponentBase"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="pro-methods"></a>
Protected Member Functions</h2></td></tr>
<tr class="memitem:a96d93e09038ee6afca3d1c7f3d2582fd"><td class="memItemLeft" align="right" valign="top">virtual void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../db/df7/classstorages_1_1mongo_1_1DistLockComponentBase.html#a96d93e09038ee6afca3d1c7f3d2582fd">DoWork</a> ()=0</td></tr>
<tr class="separator:a96d93e09038ee6afca3d1c7f3d2582fd"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:af7426693afc3c3a8eb856379d9bc6d18"><td class="memItemLeft" align="right" valign="top"><a id="af7426693afc3c3a8eb856379d9bc6d18"></a>
void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../db/df7/classstorages_1_1mongo_1_1DistLockComponentBase.html#af7426693afc3c3a8eb856379d9bc6d18">Start</a> ()</td></tr>
<tr class="memdesc:af7426693afc3c3a8eb856379d9bc6d18"><td class="mdescLeft">&#160;</td><td class="mdescRight">Must be called in constructor. <br /></td></tr>
<tr class="separator:af7426693afc3c3a8eb856379d9bc6d18"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aa220fc23e8495f45ab9e9b058801e816"><td class="memItemLeft" align="right" valign="top"><a id="aa220fc23e8495f45ab9e9b058801e816"></a>
void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../db/df7/classstorages_1_1mongo_1_1DistLockComponentBase.html#aa220fc23e8495f45ab9e9b058801e816">Stop</a> ()</td></tr>
<tr class="memdesc:aa220fc23e8495f45ab9e9b058801e816"><td class="mdescLeft">&#160;</td><td class="mdescRight">Must be called in destructor. <br /></td></tr>
<tr class="separator:aa220fc23e8495f45ab9e9b058801e816"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>Base class for mongo-based distlock worker components. </p>
<p>A component that implements a distlock with lock in Mongo. Inherit from <a class="el" href="../../db/df7/classstorages_1_1mongo_1_1DistLockComponentBase.html" title="Base class for mongo-based distlock worker components.">DistLockComponentBase</a> and implement <a class="el" href="../../db/df7/classstorages_1_1mongo_1_1DistLockComponentBase.html#a96d93e09038ee6afca3d1c7f3d2582fd">DoWork()</a>. Lock options are configured in static config.</p>
<p>Mongo might not perform well on a high load, so you might want to use postgres-based distlock <a class="el" href="../../d2/d55/classstorages_1_1postgres_1_1DistLockComponentBase.html" title="Base class for postgres-based distlock worker components.">storages::postgres::DistLockComponentBase</a> instead. </p><dl class="section see"><dt>See also</dt><dd><a class="el" href="../../d2/d55/classstorages_1_1postgres_1_1DistLockComponentBase.html" title="Base class for postgres-based distlock worker components.">storages::postgres::DistLockComponentBase</a></dd></dl>
<h2><a class="anchor" id="autotoc_md479"></a>
Cancellation checks</h2>
<p>Functions <a class="el" href="../../db/df2/cancel_8hpp.html#aed8fc1cdfd588f3973f5c9bc503c9986">engine::current_task::ShouldCancel()</a>, <a class="el" href="../../dc/d3f/namespaceengine.html#a19462f750672c6fa7f5f690c2575b9f6">engine::InterruptibleSleepFor()</a>, <a class="el" href="../../dc/d3f/namespaceengine.html#a76ed2a2c05f7445c5a944dd4fbe31b82">engine::InterruptibleSleepUntil()</a> and <a class="el" href="../../db/df2/cancel_8hpp.html#a8d5e89aac1226c90d4f8e0826ea68256" title="Throws an exception if a cancellation request for this task is pending.">engine::current_task::CancellationPoint()</a> check for task cancellation. Overriden <a class="el" href="../../db/df7/classstorages_1_1mongo_1_1DistLockComponentBase.html#a96d93e09038ee6afca3d1c7f3d2582fd">DistLockComponentBase::DoWork</a> must use the above functions to honour task cancellation and stop ASAP when it is cancelled.</p>
<h2><a class="anchor" id="autotoc_md480"></a>
Static configuration example:</h2>
<div class="fragment"><div class="line">example-distlock:</div>
<div class="line">    lockname: master</div>
<div class="line">    mongo-timeout: 1s</div>
<div class="line">    lock-ttl: 10s</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md481"></a>
Static options:</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">name </th><th class="markdownTableHeadNone">Description </th><th class="markdownTableHeadNone">Default value  </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">lockname </td><td class="markdownTableBodyNone">name of the lock </td><td class="markdownTableBodyNone">&ndash;  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">lock-ttl </td><td class="markdownTableBodyNone">TTL of the lock; must be at least as long as the duration between subsequent cancellation checks, otherwise brain split is possible </td><td class="markdownTableBodyNone">&ndash;  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">mongo-timeout </td><td class="markdownTableBodyNone">timeout, must be at least 2*lock-ttl </td><td class="markdownTableBodyNone">&ndash;  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">restart-delay </td><td class="markdownTableBodyNone">how much time to wait after failed task restart </td><td class="markdownTableBodyNone">100ms  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">task-processor </td><td class="markdownTableBodyNone">the name of the TaskProcessor for running DoWork </td><td class="markdownTableBodyNone">main-task-processor  </td></tr>
</table>

<p class="definition">Definition at line <a class="el" href="../../d5/d93/mongo_2include_2userver_2storages_2mongo_2dist__lock__component__base_8hpp_source.html#l00058">58</a> of file <a class="el" href="../../d5/d93/mongo_2include_2userver_2storages_2mongo_2dist__lock__component__base_8hpp_source.html">dist_lock_component_base.hpp</a>.</p>
</div><h2 class="groupheader">Member Function Documentation</h2>
<a id="a96d93e09038ee6afca3d1c7f3d2582fd"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a96d93e09038ee6afca3d1c7f3d2582fd">&#9670;&nbsp;</a></span>DoWork()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">virtual void storages::mongo::DistLockComponentBase::DoWork </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">protected</span><span class="mlabel">pure virtual</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">
<p>Override this function with anything that must be done under the mongo lock.</p>
<h2><a class="anchor" id="autotoc_md482"></a>
Example implementation</h2>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> MyDistLockComponent::DoWork()</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">while</span> (!engine::ShouldCancel())</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// If Foo() or other function in DoWork() throws an exception,</span></div>
<div class="line">        <span class="comment">// DoWork() will be restarted in `restart-delay` seconds.</span></div>
<div class="line">        Foo();</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// Check for cancellation after cpu-intensive Foo().</span></div>
<div class="line">        <span class="comment">// You must check for cancellation at least every `lock-ttl`</span></div>
<div class="line">        <span class="comment">// seconds to have time to notice lock prolongation failure.</span></div>
<div class="line">        <span class="keywordflow">if</span> (engine::ShouldCancel()) <span class="keywordflow">break</span>;</div>
<div class="line"> </div>
<div class="line">        Bar();</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><dl class="section note"><dt>Note</dt><dd><code>DoWork</code> must honour task cancellation and stop ASAP when it is cancelled, otherwise brain split is possible (IOW, two different users do work assuming both of them hold the lock, which is not true). </dd></dl>

</div>
</div>
<hr/>The documentation for this class was generated from the following file:<ul>
<li>userver/storages/mongo/<a class="el" href="../../d5/d93/mongo_2include_2userver_2storages_2mongo_2dist__lock__component__base_8hpp_source.html">dist_lock_component_base.hpp</a></li>
</ul>
</div><!-- contents -->
<!-- HTML footer for doxygen 1.8.13-->
<!-- start footer part -->
<hr class="footer"/>
<a id='page_edit' style="float:left; padding-left: 7pt;" href="#">⚒ Редактировать страницу</a>
<address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="../../doxygen.png" alt="doxygen"/>
</a> 1.8.17
</small></address>
<script type="text/javascript">
const LOWER_CASE_TRANSLITTERATION_MAPPING = {
    "а":"a", "б":"b", "в":"v", "г":"g", "д":"d", "е":"e", "ё":"jo", "ж":"zh",
    "з":"z", "и":"i", "й":"jj", "к":"k", "л":"l", "м":"m", "н":"n", "о":"o",
    "п":"p", "р":"r", "с":"s", "т":"t", "у":"u", "ф":"f", "х":"x", "ц":"c",
    "ч":"ch", "ш":"sh", "щ":"shh", "ъ":"\'", "ы":"y", "ь":"\'", "э":"je",
    "ю":"ju", "я":"ja"
};
const DOXYGEN_DIAMOND_STRING = '◆\u00A0' // ◆&nbsp;
function make_id(raw_id) {
    return raw_id.toLowerCase().split('').map(function (char) {
        return LOWER_CASE_TRANSLITTERATION_MAPPING[char] || char;
    }).join('').replace(/\W/g, '');
}
const html_escape = function () {
    const p = document.createElement('p');
    return function (text) {
        p.textContent = text;
        return p.innerHTML;
    };
}();
function setup_page_edit() {
    let href = window.location.href;
    const idx = href.indexOf('md_ru_');
    if (idx === -1) {
        $('#page_edit').hide();
        return;
    }
    href = href.substring(idx).split('.html')[0];
    href = href.split('#')[0];
    href = href.replace('md_ru_', 'https://wiki.yandex-team.ru/taxi/backend/');
    href = href.replaceAll('_', '/');
    $('#page_edit').attr("href", href + '/.edit');
}
function draw_toc() {
    let headers = $(':header');
    if (headers.length === 0) {
        return;
    }
    let sidenav_content = '<div id="mySidenav" class="sidenav">';
    sidenav_content += '<h2>Table of contents</h2>';
    headers.each(function() {
        let index = parseInt(this.nodeName.substring(1)) - 1;
        const header = $(this);
        let id = header.attr('id');
        if (!id) {
          id = make_id(header.text())
          header.attr('id', id);
        }
        let header_text = header.text()
        if (header_text.startsWith(DOXYGEN_DIAMOND_STRING)) {
            ++index;
            header_text = header_text.substring(DOXYGEN_DIAMOND_STRING.length);
        }
        sidenav_content += ''
          + '<a href="#' + id + '" style="padding-left: ' + index * 15 + 'px">'
          + '•&nbsp;' + html_escape(header_text)
          + '</a>'
        ;
        header.append(' <a class="hoverlink" href="#' + id + '">🔗</a>')
    });
    sidenav_content += '</div>';
    $(sidenav_content).insertAfter('.header');
}
function highlight_code() {
    if (window.location.href.indexOf("pp_source") !== -1
        || window.location.href.indexOf("cpp-example") !== -1) {
        // Header listing is already nicely highlighted by Doxygen
        return;
    }
    hljs.configure({
        tabReplace: '    ' // 4 spaces
    });
    hljs.registerAliases('py', {languageName: 'python'});
    hljs.registerAliases('sh', {languageName: 'shell'});
    hljs.registerAliases('bash', {languageName: 'shell'});
    hljs.registerAliases('yml', {languageName: 'yaml'});
    hljs.registerAliases('plain', {languageName: 'plaintext'});
    hljs.registerAliases('tskv', {languageName: 'plaintext'});
    $(".fragment").each(function() {
        const node = $(this);
        let data = '';
        let language = '';
        let requires_higlighting = true;
        node.children('div.line').each(function(i) {
            line = $(this).text();
            // Doxygen 1.8.11 workaround to remove line numbers.
            // No line numbers added in Doxygen 1.8.13
            line = line.replace(/^ *\d+\xA0/, '');
            if (i === 0) {
                line = line.trimLeft().replace(/^# /, '');
                if (line === 'autodetect') {
                    return true;
                } else if (hljs.getLanguage(line)) {
                    language = line;
                    return true;
                } else {
                    requires_higlighting = false;
                    return false;
                }
            }
            data += line + '\n';
        });
        if (requires_higlighting === false) {
            return;
        }
        if (language !== '') {
            data = hljs.highlight(language, data).value;
        } else {
            data = hljs.highlightAuto(data).value;
        }
        node.replaceWith('<div class="fragment"><pre>' + data + '</pre></div>');
    });
}
function setup_if_landing() {
    if (document.getElementById('landing_logo_id') === null) {
        return false;
    }
    $('#titlearea').hide();
    const main_nav = $('#main-nav')
    main_nav.addClass('main-nav-landing');
    main_nav.append('<hr>');
    $('.header').hide();
    $('body').css('background-color', 'black');
    $('#page_edit').hide();
    return true;
}
function sticky_menu() {
    const main_nav = $('#main-nav');
    const menu_y_position = 94;
    const search_results_window = $('#MSearchResultsWindow');
    var menu_is_sticky = false;
    const stick = function () {
        if ($(this).scrollTop() > menu_y_position) {
            if (menu_is_sticky) return;
            search_results_window.addClass('stickySearchResults');
            main_nav.addClass('stickyHeader');
            menu_is_sticky = true;
        } else {
            if (!menu_is_sticky) return;
            search_results_window.removeClass('stickySearchResults');
            // 'top' property of the results window is computed by Doxygen JS
            // and it may give bad results if the computation is invoked at the
            // middle of the page.
            //
            // Hiding the window. Doxygen will recompute and show it on new
            // user input.
            search_results_window.hide();
            main_nav.removeClass('stickyHeader');
            menu_is_sticky = false;
        }
    };
    stick();  // on page refresh draw the menu on a right position
    $(window).on("scroll", stick);
}
function telegram_channel_language() {
  if (/^ru/.test(navigator.language)) {
    const channel = $('#telegram_channel');
    if (channel) {
      channel.attr('href', 'https://t.me/+AdadhDPVG5xhNWRi');
    }
  }
}
$(function() {
    if (setup_if_landing()) return;
    draw_toc();
    highlight_code();
    setup_page_edit();
    telegram_channel_language();
    sticky_menu();
});
</script>
</body>
</html>
